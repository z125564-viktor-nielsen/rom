{% extends 'base.html' %}

{% block title %}{{ game.title }} — {{ game.base_game or 'Decompiled Port' }} for {{ (game.consoles or [game.console]) | join(', ') }} | ROMHACKS.NET{% endblock %}
{% block og_type %}article{% endblock %}
{% block meta_image %}{{ game.image_url }}{% endblock %}
{% block meta_description %}{{ (game.title ~ ' decompiled port of ' ~ (game.base_game or 'the original') ~ ' with downloads for ' ~ ((game.consoles or [game.console]) | join(', ')) ~ '. ' ~ (game.description or 'Includes install steps, patch links, and notes from the team.')) | truncate(155, True, '…') }}{% endblock %}
{% block meta_keywords %}{{ game.title }}, {{ game.base_game }}, {{ (game.consoles or [game.console]) | join(', ') }}, decompiled port, download, how to install{% endblock %}

{% block json_ld %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "VideoGame",
    "name": {{ (game.title or '') | tojson }},
    "description": {{ (game.description or '') | tojson }},
    "url": {{ url_for('port_page', port_id=game.id, _external=True) | tojson }},
    "image": {{ (game.image_url or '') | tojson }},
    "creator": {
        "@type": "Person",
        "name": {{ (game.author or 'ROMHACKS.NET Team') | tojson }}
    },
    "datePublished": {{ (game.release_date or '') | tojson }},
    "softwareVersion": {{ (game.version or '') | tojson }},
    "applicationPlatform": {{ ((game.consoles or [game.console]) | join('/')) | tojson }},
    "isBasedOn": {{ (game.base_game or '') | tojson }},
    "offers": {
        "@type": "Offer",
        "url": {{ (game.download_link or url_for('port_page', port_id=game.id, _external=True)) | tojson }},
        "availability": "https://schema.org/InStock",
        "price": "0",
        "priceCurrency": "USD"
    }
}
</script>
{% endblock %}

{% block content %}
<div class="flex flex-col gap-6 max-w-6xl mx-auto">
    <div class="relative min-h-[280px] md:h-[380px] rounded-2xl overflow-hidden border border-gray-700/50 shadow-2xl bg-gradient-to-br from-gray-800 to-gray-900">
        <img src="{{ game.image_url }}" loading="lazy" decoding="async" class="w-full h-full object-contain object-center opacity-40" alt="{{ game.title }} - {{ game.console }} Port Cover Art">
        <div class="absolute inset-0 bg-gradient-to-t from-[#050507] to-transparent"></div>
        <div class="absolute bottom-0 left-0 right-0 p-4 md:p-8">
            <div class="flex items-end justify-between">
                <div>
                    <div class="flex flex-wrap items-center gap-1.5 md:gap-4 mb-3 md:mb-4">
                        {% for c in (game.consoles or [game.console]) %}
                        <span class="{{ styles.get(c, styles.get('default', 'bg-gray-800 text-gray-300 border-gray-600')) }} text-[10px] font-bold px-3 py-1 rounded border uppercase bg-opacity-80">{{ c }}</span>
                        {% endfor %}
                        <span class="text-xs font-mono text-gray-400 border border-gray-700 px-2 py-1 bg-black/50">Released: {{ game.release_date[:4] if game.release_date else '' }}</span>
                    </div>
                    <h1 class="text-3xl md:text-5xl font-bold text-white pixel-font mb-6">{{ game.title }}</h1>
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
                        <div class="border-l-2 border-blue-400 pl-3">
                            <div class="text-xs text-gray-400 uppercase font-bold tracking-wider">By {{ game.author }}</div>
                        </div>
                        <div class="border-l-2 border-blue-400 pl-3">
                            <div class="text-xs text-gray-400 uppercase font-bold tracking-wider">Latest Version</div>
                            <div class="text-lg text-white font-mono font-semibold">{{ game.version }}</div>
                        </div>
                    </div>
                </div>
                {% if social_links %}
                <div class="flex flex-col gap-2">
                    {% for link in social_links %}
                    <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center w-12 h-12 rounded-lg bg-gray-800/50 border border-gray-700/50 hover:border-blue-400/50 hover:bg-gray-800 transition-all group" title="{{ link.type|replace('_', ' ')|title }}">
                        {% if link.type == 'twitter' %}
                        <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-400 transition-colors" fill="currentColor" viewBox="0 0 24 24"><path d="M23 3a10.9 10.9 0 01-3.14 1.53 4.48 4.48 0 00-7.86 3v1A10.66 10.66 0 013 4s-4 9 5 13a11.64 11.64 0 01-7 2s9 5 20 5a9.5 9.5 0 00-9-5.5c4.75 2.25 7-7 7-7a4.5 4.5 0 01-4.5-4.5"/></svg>
                        {% elif link.type == 'discord' %}
                        <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-400 transition-colors" fill="currentColor" viewBox="0 0 24 24"><path d="M20.317 4.369a19.791 19.791 0 00-4.885-1.515.074.074 0 00-.079.037c-.211.375-.445.864-.607 1.25a18.27 18.27 0 00-5.487 0c-.162-.386-.395-.875-.607-1.25a.077.077 0 00-.079-.037A19.736 19.736 0 003.677 4.37a.07.07 0 00-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 00.031.057 19.9 19.9 0 005.993 3.03.08.08 0 00.087-.027c.461-.63.873-1.295 1.226-1.994a.076.076 0 00-.042-.106 13.107 13.107 0 01-1.872-.892.077.077 0 00-.008-.128 10.72 10.72 0 00.372-.294.075.075 0 00.076-.01c3.928 1.793 8.18 1.793 12.062 0a.075.075 0 00.076.009c.12.098.246.198.373.294a.077.077 0 00-.006.127 12.299 12.299 0 01-1.873.892.076.076 0 00-.041.107c.36.699.772 1.365 1.225 1.994a.08.08 0 00.087.028 19.86 19.86 0 006.002-3.03.077.077 0 00.032-.056c.5-4.506.8-8.987.111-13.374a.07.07 0 00-.031-.027zM8.02 15.33c-1.183 0-2.157-.965-2.157-2.156 0-1.193.964-2.157 2.157-2.157 1.193 0 2.156.964 2.156 2.157 0 1.19-.963 2.156-2.156 2.156zm7.975 0c-1.183 0-2.157-.965-2.157-2.156 0-1.193.964-2.157 2.157-2.157 1.193 0 2.157.964 2.157 2.157 0 1.19-.964 2.156-2.157 2.156z"/></svg>
                        {% elif link.type == 'github' %}
                        <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-400 transition-colors" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v 3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                        {% elif link.type == 'website' %}
                        <span class="material-symbols-outlined text-lg text-gray-400 group-hover:text-blue-400 transition-colors">language</span>
                        {% else %}
                        <span class="material-symbols-outlined text-lg text-gray-400 group-hover:text-blue-400 transition-colors">language</span>
                        {% endif %}
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Screenshots and Info Section -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 no-crt-filter">
        <!-- Main Content Column -->
        <div class="lg:col-span-2 space-y-8 flex flex-col">
            <!-- Screenshots Section -->
            {% if game.screenshots %}
            <div class="space-y-4 order-1 lg:order-1">
                <h3 class="text-xl font-bold text-white pixel-font flex items-center gap-2">
                    <span class="material-symbols-outlined text-blue-500">photo_library</span> Screenshots
                </h3>
                <!-- Main Screenshot Display -->
                <div class="relative rounded-xl overflow-hidden border border-gray-800 bg-black/20 shadow-lg aspect-video group cursor-pointer" onclick="openScreenshotModal(currentScreenshotIndex)">
                    <img id="main-screenshot" src="{{ game.screenshots[0] }}" loading="lazy" decoding="async" class="w-full h-full object-contain" alt="{{ game.title }} Screenshot">
                    
                    <!-- Navigation Arrows Overlay -->
                    {% if game.screenshots|length > 1 %}
                    <button onclick="selectScreenshot(currentScreenshotIndex - 1); event.stopPropagation();" class="absolute left-4 top-1/2 -translate-y-1/2 text-white/50 hover:text-white transition-all opacity-0 group-hover:opacity-100 p-2" id="prev-arrow">
                        <span class="material-symbols-outlined text-4xl">chevron_left</span>
                    </button>
                    <button onclick="selectScreenshot(currentScreenshotIndex + 1); event.stopPropagation();" class="absolute right-4 top-1/2 -translate-y-1/2 text-white/50 hover:text-white transition-all opacity-0 group-hover:opacity-100 p-2" id="next-arrow">
                        <span class="material-symbols-outlined text-4xl">chevron_right</span>
                    </button>
                    {% endif %}
                    <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-all flex items-center justify-center opacity-0 group-hover:opacity-100">
                        <span class="material-symbols-outlined text-white text-5xl">zoom_in</span>
                    </div>
                </div>
                
                <!-- Thumbnail Navigation -->
                {% if game.screenshots|length > 1 %}
                <div class="flex justify-center">
                    <div class="overflow-hidden">
                        <div id="thumbnail-container" class="flex gap-2 transition-transform duration-300">
                            {% for shot in game.screenshots %}
                            <button 
                                class="flex-shrink-0 w-20 h-20 rounded border-2 transition-all cursor-pointer hover:border-blue-400 {% if loop.first %}border-blue-400{% else %}border-gray-700/50{% endif %} overflow-hidden"
                                onclick="selectScreenshot({{ loop.index0 }})"
                                title="Screenshot {{ loop.index }}">
                                <img src="{{ shot }}" class="w-full h-full object-cover" alt="Screenshot {{ loop.index }}">
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Platform Instructions -->
            {% if instructions %}
            <section class="order-3 lg:order-2">
                <h3 class="text-xl font-bold text-white mb-4 border-b border-gray-700/50 pb-2 flex items-center gap-2">
                    <span class="material-symbols-outlined text-blue-500">info</span>
                    Platform Instructions
                </h3>
                <div class="space-y-3">
                    {% for platform, steps in instructions.items() %}
                    {% set pid = platform|replace(' ', '-')|lower %}
                    <div class="border border-gray-700/50 rounded-lg overflow-hidden">
                        <button onclick="toggleInstructions('{{ pid }}')" class="w-full px-6 py-4 bg-gray-900/50 hover:bg-gray-800/50 transition-all flex items-center justify-between group">
                            <div class="flex items-center gap-3">
                                <!-- Platform Icon -->
                                {% if 'pc' in platform|lower or 'windows' in platform|lower %}
                                <svg class="w-5 h-5 text-blue-400" fill="currentColor" viewBox="0 0 24 24"><path d="M3,12V6.75L9,5.43V11.91L3,12M20,3V11.75L10,11.9V5.21L20,3M3,13L9,13.09V19.9L3,18.75V13M20,13.25V22L10,20.09V13.1L20,13.25Z"/></svg>
                                {% elif 'android' in platform|lower %}
                                <svg class="w-5 h-5 text-green-400" fill="currentColor" viewBox="0 0 24 24"><path d="M17.6 9.48l1.84-3.18c.16-.31.04-.69-.26-.85-.29-.15-.68-.04-.84.27l-1.88 3.24c-2.86-1.21-6.08-1.21-8.94 0L5.65 5.67c-.16-.31-.55-.42-.84-.27-.3.16-.42.54-.26.85L7.4 9.48c-3.5 2.55-5.4 6.2-5.4 10.52h17.98c0-4.32-1.9-7.97-5.38-10.52zM8 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm8 0c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
                                {% elif 'linux' in platform|lower %}
                                <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12.504 0c-.155 0-.315.008-.48.021-4.226.333-3.105 4.807-3.17 6.298-.076 1.092-.3 1.953-1.05 3.02-.885 1.051-2.127 2.75-2.716 4.521-.278.832-.41 1.684-.287 2.489a.424.424 0 00-.11.135c-.26.268-.45.6-.663.839-.199.199-.485.267-.797.4-.313.136-.658.269-.864.68-.09.189-.136.394-.132.602 0 .199.027.4.055.536.058.399.116.728.04.97-.249.68-.28 1.145-.106 1.484.174.334.535.47.94.601.81.2 1.91.135 2.774.6.926.466 1.866.67 2.616.47.526-.116.97-.464 1.208-.946.587-.003 1.23-.269 2.26-.334.699-.058 1.574.267 2.577.2.025.134.063.198.114.333l.003.003c.391.778 1.113 1.132 1.884 1.071.771-.06 1.592-.536 2.257-1.306.631-.765 1.683-1.084 2.378-1.503.348-.199.629-.469.649-.853.023-.4-.2-.811-.714-1.376v-.097l-.003-.003c-.17-.2-.25-.535-.338-.926-.085-.401-.182-.786-.492-1.046h-.003c-.059-.054-.123-.067-.188-.135a.357.357 0 00-.19-.064c.431-1.278.264-2.55-.173-3.694-.533-1.41-1.465-2.638-2.175-3.483-.796-1.005-1.576-1.957-1.56-3.368.026-2.152.236-6.133-3.544-6.139zm.529 3.405h.013c.213 0 .396.062.584.198.19.135.33.332.438.533.105.259.158.459.166.724 0-.02.006-.04.006-.06v.105a.086.086 0 01-.004-.021l-.004-.024a1.807 1.807 0 01-.15.706.953.953 0 01-.213.335.71.71 0 00-.088-.042c-.104-.045-.198-.064-.284-.133a1.312 1.312 0 00-.22-.066c.05-.06.146-.133.183-.198.053-.128.082-.264.088-.402v-.02a.53.53 0 00-.043-.182.35.35 0 00-.12-.149.27.27 0 00-.166-.045c-.066 0-.13.023-.166.045a.35.35 0 00-.12.149.53.53 0 00-.043.182v.02c.006.138.035.274.088.402.037.065.133.138.183.198a1.572 1.572 0 00-.22.066c-.086.069-.18.088-.284.133a.71.71 0 00-.088.042.953.953 0 01-.213-.335 1.807 1.807 0 01-.15-.706l-.004.024a.086.086 0 01-.004.021v-.105c0 .02.006.04.006.06.008-.265.061-.465.166-.724.108-.2.248-.398.438-.533.188-.136.371-.198.584-.198zm-4.31.702c.266 0 .469.06.636.181.166.178.312.332.418.598.106.201.143.467.172.666-.006.146-.038.284-.092.418-.058.135-.143.259-.223.339a.69.69 0 01-.25.158c-.09.06-.166.09-.242.09-.021 0-.045.003-.06.003l-.003-.003a.382.382 0 01-.117-.03.44.44 0 00-.127-.045.113.113 0 00-.046-.003c-.038 0-.075.01-.114.024a.61.61 0 00-.132.087c-.053.046-.098.092-.132.135a.55.55 0 00-.076.135c-.003.045-.003.09-.003.135.003.045.006.09.003.135-.006.135-.033.201-.06.27a.61.61 0 01-.087.158c-.064.07-.137.129-.192.166a.488.488 0 01-.18.09c-.066.024-.135.045-.2.059-.13.022-.262.024-.393.006-.132-.03-.262-.075-.384-.135-.184-.105-.35-.254-.488-.408a1.18 1.18 0 01-.27-.465c-.06-.18-.09-.381-.09-.582 0-.201.03-.402.09-.582.06-.179.15-.345.27-.466.138-.153.304-.302.488-.407.122-.06.252-.106.384-.135a.86.86 0 01.393.006c.065.014.134.035.2.059a.49.49 0 01.18.09c.055.037.128.096.192.166a.61.61 0 01.087.158c.027.069.054.135.06.27.003.045 0 .09-.003.135 0 .045 0 .09.003.135a.55.55 0 00.076.135c.034.043.079.09.132.135a.61.61 0 00.132.087c.039.014.076.024.114.024a.113.113 0 00.046-.003.44.44 0 00.127-.045.382.382 0 01.117-.03l.003-.003c.015 0 .039.003.06.003.076 0 .152-.03.242-.09a.69.69 0 00.25-.158c.08-.08.165-.204.223-.339.054-.134.086-.272.092-.418-.029-.199-.066-.465-.172-.666-.106-.266-.252-.42-.418-.598-.167-.121-.37-.181-.636-.181z"/></svg>
                                {% elif 'mac' in platform|lower or 'macos' in platform|lower %}
                                <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 24 24"><path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/></svg>
                                {% elif 'ios' in platform|lower or 'iphone' in platform|lower or 'ipad' in platform|lower %}
                                <svg class="w-5 h-5 text-gray-300" fill="currentColor" viewBox="0 0 24 24"><path d="M17 2H7c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-5 18c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm5.5-3H6V4h11v13z"/></svg>
                                {% elif 'switch' in platform|lower or 'nintendo' in platform|lower %}
                                <svg class="w-5 h-5 text-red-400" fill="currentColor" viewBox="0 0 24 24"><path d="M14.176 24h3.674c3.376 0 6.15-2.774 6.15-6.15V6.15C24 2.775 21.226 0 17.85 0H14.1c-.074 0-.15.074-.15.15v23.7c-.001.076.075.15.226.15zm4.574-13.199c1.351 0 2.399 1.125 2.399 2.398 0 1.352-1.125 2.4-2.399 2.4-1.35 0-2.4-1.049-2.4-2.4-.075-1.349 1.05-2.398 2.4-2.398zM11.4 0H6.15C2.775 0 0 2.775 0 6.15v11.7C0 21.226 2.775 24 6.15 24h5.25c.074 0 .15-.074.15-.149V.15c0-.076-.076-.15-.15-.15zM6.602 8.799c1.35 0 2.398 1.05 2.398 2.4s-1.049 2.398-2.398 2.398c-1.352 0-2.4-1.049-2.4-2.398s1.048-2.4 2.4-2.4z"/></svg>
                                {% else %}
                                <span class="material-symbols-outlined text-blue-300 text-lg">devices</span>
                                {% endif %}
                                <span class="font-bold text-white">{{ platform }}</span>
                            </div>
                            <span class="material-symbols-outlined text-gray-400 group-hover:text-white transition-all transform text-lg font-bold" id="icon-{{ pid }}">expand_more</span>
                        </button>
                        <div id="content-{{ pid }}" class="instructions-content hidden max-h-0 overflow-hidden transition-all duration-300">
                            <div class="space-y-4 px-6 py-4 bg-blue-900/20 border-t border-blue-500/30">
                                <div class="text-sm text-gray-300 leading-relaxed whitespace-pre-line">{{ steps|replace('\\n', '\n') }}</div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>
            {% endif %}

            <!-- Modding Support Section - Show if mod_links or mod_instructions exist -->
            {% if game.mod_links or game.mod_instructions %}
            <section class="order-4 lg:order-3">
                <h3 class="text-xl font-bold text-white mb-4 border-b border-gray-800 pb-2 flex items-center gap-2">
                    <span class="material-symbols-outlined text-purple-400">build</span>
                    Modding Support
                </h3>
                <div class="border border-purple-700/50 rounded-lg overflow-hidden bg-gray-900/30">
                    <!-- Mod Site Link -->
                    {% if game.mod_links %}
                    <div class="px-6 py-4 border-b border-purple-700/30">
                        <div class="flex flex-col gap-2">
                            {% for link in game.mod_links %}
                            <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer" 
                               class="group flex items-center justify-between px-4 py-3 bg-purple-900/40 hover:bg-purple-800/60 border border-purple-600/50 rounded-lg transition-all hover:border-purple-400/50 hover:shadow-[0_0_15px_rgba(168,85,247,0.2)]">
                                <div class="flex items-center gap-3">
                                    <div class="bg-purple-800/50 p-2 rounded-md group-hover:bg-purple-700/50 transition-colors">
                                        <span class="material-symbols-outlined text-purple-200">hub</span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-purple-100 font-bold group-hover:text-white transition-colors">Mod Repository</span>
                                        <span class="text-xs text-purple-300 group-hover:text-purple-200 transition-colors">Visit {{ link.name }}</span>
                                    </div>
                                </div>
                                <span class="material-symbols-outlined text-purple-400 group-hover:translate-x-1 transition-transform">arrow_forward</span>
                            </a>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Mod Instructions -->
                    {% if game.mod_instructions %}
                    <div class="px-6 py-4">
                        <h4 class="text-sm font-bold text-purple-300 mb-3 flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">menu_book</span>
                            How to Install Mods
                        </h4>
                        <div class="text-xs text-gray-400 leading-relaxed whitespace-pre-line bg-[#151518] p-4 rounded-lg border border-gray-700/50">{{ game.mod_instructions|replace('\\n', '\n') }}</div>
                    </div>
                    {% endif %}
                </div>
            </section>
            {% endif %}
        </div>

        <!-- Info Sidebar on Right -->
        <div class="lg:col-span-1 space-y-6 order-2 lg:order-3">
            <div class="bg-gray-900/50 border border-gray-700/50 p-6 rounded-xl sticky top-24 shadow-lg">
                <div class="mb-6">
                    <div class="text-xs text-gray-500 uppercase font-bold mb-1">Base Game</div>
                    <div class="text-sm text-gray-300">{{ game.base_game }}</div>
                </div>

                {% if game.original_platform %}
                <div class="mb-6">
                    <div class="text-xs text-gray-500 uppercase font-bold mb-1">Original Platform</div>
                    <div class="text-sm text-gray-300">
                        {% if game.original_platform|lower == 'nintendo 64' %}
                            N64
                        {% elif game.original_platform|lower == 'game boy' %}
                            GB
                        {% elif game.original_platform|lower == 'game boy color' %}
                            GBC
                        {% elif game.original_platform|lower == 'game boy advance' %}
                            GBA
                        {% elif game.original_platform|lower == 'super nintendo' %}
                            SNES
                        {% elif game.original_platform|lower == 'nintendo ds' %}
                            NDS
                        {% else %}
                            {{ game.original_platform }}
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                {% if game.instruction and game.instruction_text %}
                <div class="mb-6 bg-red-900/30 p-4 rounded-lg border border-red-700/50">
                    <div class="flex items-start gap-3 mb-2">
                        <span class="material-symbols-outlined text-red-400 text-lg flex-shrink-0 mt-0.5">warning</span>
                        <div>
                            <div class="text-xs text-red-300 uppercase font-bold mb-2">This port has special instructions!</div>
                            <p class="text-xs text-red-100 leading-relaxed whitespace-pre-wrap">{{ game.instruction_text }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}

                <a href="{{ game.download_link }}" target="_blank" onclick="trackDownload('{{ game.id }}')" class="btn-retro w-full justify-center text-center py-4 mb-2">
                    Download Port
                </a>
                <p class="text-[10px] text-gray-500 text-center mb-4 italic">Redirects to official download page</p>

                <div class="flex items-center justify-between px-2 py-2 mb-4">
                    <span class="inline-flex items-center gap-2 text-[12px] font-mono text-gray-300">
                        <span class="material-symbols-outlined text-[14px] text-blue-400">download</span>
                        {{ download_count | default(0) | download_count_label }} downloads
                    </span>
                </div>

                {% if game.features %}
                <div class="border-t border-gray-800 pt-4 mt-4">
                    <div class="text-xs text-gray-500 uppercase font-bold mb-3">Key Features</div>
                    <ul class="space-y-2">
                        {% if game.online_play %}
                        <li class="flex items-center gap-2 text-xs text-green-300">
                            <span class="material-symbols-outlined text-green-400 text-sm">lan</span> 
                            Online Play
                        </li>
                        {% endif %}
                        {% for feature in game.features %}
                        <li class="flex items-center gap-2 text-xs text-gray-300">
                            <span class="material-symbols-outlined text-blue-500 text-sm">check_circle</span> 
                            {{ feature }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% elif game.online_play %}
                <div class="border-t border-gray-800 pt-4 mt-4">
                    <div class="text-xs text-gray-500 uppercase font-bold mb-3">Features</div>
                    <ul class="space-y-2">
                        <li class="flex items-center gap-2 text-xs text-green-300">
                            <span class="material-symbols-outlined text-green-400 text-sm">lan</span> 
                            Online Play
                        </li>
                    </ul>
                </div>
                {% endif %}

                <!-- Need Help Section -->
                {% if social_links %}
                <div class="border border-gray-700/50 rounded-lg p-4 bg-gray-900/30 mt-4">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="material-symbols-outlined text-yellow-500 text-lg">help</span>
                        <h4 class="text-sm font-bold text-white">Need Help?</h4>
                    </div>
                    <div class="space-y-2 text-xs text-gray-400">
                        <p class="mb-2">Experiencing problems? Check out these resources:</p>
                        <div class="flex flex-col gap-2">
                            {% for link in social_links %}
                            {% if link.type == 'discord' %}
                            <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-blue-400 hover:text-blue-300 transition-all">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M20.317 4.369a19.791 19.791 0 00-4.885-1.515.074.074 0 00-.079.037c-.211.375-.445.864-.607 1.25a18.27 18.27 0 00-5.487 0c-.162-.386-.395-.875-.607-1.25a.077.077 0 00-.079-.037A19.736 19.736 0 003.677 4.37a.07.07 0 00-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 00.031.057 19.9 19.9 0 005.993 3.03.08.08 0 00.087-.027c.461-.63.873-1.295 1.226-1.994a.076.076 0 00-.042-.106 13.107 13.107 0 01-1.872-.892.077.077 0 00-.008-.128 10.72 10.72 0 00.372-.294.075.075 0 00.076-.01c3.928 1.793 8.18 1.793 12.062 0a.075.075 0 00.076.009c.12.098.246.198.373.294a.077.077 0 00-.006.127 12.299 12.299 0 01-1.873.892.076.076 0 00-.041.107c.36.699.772 1.365 1.225 1.994a.08.08 0 00.087.028 19.86 19.86 0 006.002-3.03.077.077 0 00.032-.056c.5-5.094-.838-9.52-3.549-13.442a.06.06 0 00-.031-.028zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
                                <span>Discord Server</span>
                            </a>
                            {% elif link.type == 'github' %}
                            <a href="{{ link.url }}/issues" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-blue-400 hover:text-blue-300 transition-all">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                                <span>Report Issues on GitHub</span>
                            </a>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <div class="border-t border-gray-800 pt-4 mt-4">
                    <p class="text-[10px] text-gray-500 mb-2">Have the base file?</p>
                    <a href="/patcher" class="block text-center text-blue-400 text-xs hover:text-white border border-blue-500/30 hover:border-blue-500 py-2 rounded-lg transition-all">
                        Go to Web Patcher
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="flex justify-center mt-8 mb-4">
        <a href="{{ url_for('contact') }}" class="inline-flex items-center gap-2 text-gray-500 hover:text-blue-400 text-sm transition-all">
            <span class="material-symbols-outlined text-base">report</span>
            Incorrect info?
        </a>
    </div>

</div>

<!-- Screenshot Modal Lightbox -->
<div id="screenshot-modal" class="fixed inset-0 bg-black/90 hidden z-50 flex items-center justify-center p-4" onclick="closeScreenshotModal(event)">
    <button onclick="closeScreenshotModal()" class="absolute top-4 right-4 text-white/70 hover:text-white transition-all">
        <span class="material-symbols-outlined text-4xl">close</span>
    </button>
    
    <div class="relative w-full h-full flex items-center justify-center" onclick="event.stopPropagation()">
        <img id="modal-screenshot" src="" loading="lazy" decoding="async" class="max-w-full max-h-full object-contain" alt="Enlarged screenshot">
        
        <!-- Modal Navigation -->
        <button onclick="modalPrevScreenshot()" class="absolute left-4 top-1/2 -translate-y-1/2 text-white/50 hover:text-white transition-all p-3" id="modal-prev-arrow">
            <span class="material-symbols-outlined text-5xl">chevron_left</span>
        </button>
        <button onclick="modalNextScreenshot()" class="absolute right-4 top-1/2 -translate-y-1/2 text-white/50 hover:text-white transition-all p-3" id="modal-next-arrow">
            <span class="material-symbols-outlined text-5xl">chevron_right</span>
        </button>
        
        <!-- Screenshot Counter -->
        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-black/50 px-4 py-2 rounded-lg text-white/70 text-sm font-mono">
            <span id="modal-counter">1</span> / <span id="modal-total">1</span>
        </div>
    </div>
</div>

<!-- Screenshot Navigation Scripts -->
<script>
const allScreenshots = [
    {% for shot in game.screenshots %}'{{ shot }}'{{ "," if not loop.last }}{% endfor %}
];

let currentScreenshotIndex = 0;
const thumbnailWidth = 88; // width (80px) + gap (8px)

function selectScreenshot(index) {
    // Clamp index to valid range
    index = Math.max(0, Math.min(index, allScreenshots.length - 1));
    currentScreenshotIndex = index;
    
    const mainImg = document.getElementById('main-screenshot');
    if (mainImg) {
        mainImg.src = allScreenshots[index];
    }
    
    // Update thumbnail borders
    document.querySelectorAll('#thumbnail-container button').forEach((btn, i) => {
        btn.classList.toggle('border-blue-400', i === index);
        btn.classList.toggle('border-gray-700/50', i !== index);
    });
    
    // Auto-scroll to show selected thumbnail
    ensureThumbbnailVisible(index);
    updateArrowState();
}

function scrollThumbnails(direction) {
    const container = document.getElementById('thumbnail-container');
    if (!container) return;
    const scrollAmount = thumbnailWidth * 3; // Scroll by 3 thumbnails
    container.scrollBy({ left: direction * scrollAmount, behavior: 'smooth' });
}

function ensureThumbbnailVisible(index) {
    const container = document.getElementById('thumbnail-container');
    if (!container) return;
    const button = container.querySelector(`button:nth-child(${index + 1})`);
    if (button) {
        button.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    }
}

function updateArrowState() {
    const prevArrow = document.getElementById('prev-arrow');
    const nextArrow = document.getElementById('next-arrow');
    
    if (prevArrow) {
        prevArrow.style.opacity = currentScreenshotIndex === 0 ? '0' : '1';
        prevArrow.style.pointerEvents = currentScreenshotIndex === 0 ? 'none' : 'auto';
    }
    
    if (nextArrow) {
        nextArrow.style.opacity = currentScreenshotIndex >= allScreenshots.length - 1 ? '0' : '1';
        nextArrow.style.pointerEvents = currentScreenshotIndex >= allScreenshots.length - 1 ? 'none' : 'auto';
    }
}

// Keyboard navigation
document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft' && currentScreenshotIndex > 0) {
        selectScreenshot(currentScreenshotIndex - 1);
    } else if (e.key === 'ArrowRight' && currentScreenshotIndex < allScreenshots.length - 1) {
        selectScreenshot(currentScreenshotIndex + 1);
    }
});

// Update arrow states on load and resize
window.addEventListener('load', updateArrowState);
window.addEventListener('resize', updateArrowState);

// Swipe gesture for screenshot navigation
let touchStartX = 0;
let touchEndX = 0;

function handleSwipe(container) {
    if (touchStartX - touchEndX > 50) {
        // Swiped left - go to next screenshot
        if (currentScreenshotIndex < allScreenshots.length - 1) {
            selectScreenshot(currentScreenshotIndex + 1);
        }
    } else if (touchEndX - touchStartX > 50) {
        // Swiped right - go to previous screenshot
        if (currentScreenshotIndex > 0) {
            selectScreenshot(currentScreenshotIndex - 1);
        }
    }
}

document.addEventListener('touchstart', (e) => {
    const screenshotContainer = document.getElementById('main-screenshot');
    if (!screenshotContainer) return;
    const mainContainer = screenshotContainer.closest('.relative');
    if (mainContainer && mainContainer.contains(e.target)) {
        touchStartX = e.changedTouches[0].screenX;
    }
}, false);

document.addEventListener('touchend', (e) => {
    const screenshotContainer = document.getElementById('main-screenshot');
    if (!screenshotContainer) return;
    const mainContainer = screenshotContainer.closest('.relative');
    if (mainContainer && mainContainer.contains(e.target)) {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe(mainContainer);
    }
}, false);

// Screenshot Modal Functions
function openScreenshotModal(index) {
    const modal = document.getElementById('screenshot-modal');
    const modalImg = document.getElementById('modal-screenshot');
    const counter = document.getElementById('modal-counter');
    const total = document.getElementById('modal-total');
    
    if (modal && modalImg && allScreenshots.length > 0) {
        currentScreenshotIndex = Math.max(0, Math.min(index, allScreenshots.length - 1));
        modalImg.src = allScreenshots[currentScreenshotIndex];
        counter.textContent = currentScreenshotIndex + 1;
        total.textContent = allScreenshots.length;
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        updateModalArrowState();
    }
}

function closeScreenshotModal(event) {
    // Only close if clicking the background, not the image
    if (event && event.target.id !== 'screenshot-modal') return;
    
    const modal = document.getElementById('screenshot-modal');
    if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
    }
}

function modalNextScreenshot() {
    if (currentScreenshotIndex < allScreenshots.length - 1) {
        currentScreenshotIndex++;
        updateModalImage();
    }
}

function modalPrevScreenshot() {
    if (currentScreenshotIndex > 0) {
        currentScreenshotIndex--;
        updateModalImage();
    }
}

function updateModalImage() {
    const modalImg = document.getElementById('modal-screenshot');
    const counter = document.getElementById('modal-counter');
    
    if (modalImg && allScreenshots.length > 0) {
        modalImg.src = allScreenshots[currentScreenshotIndex];
        counter.textContent = currentScreenshotIndex + 1;
        updateModalArrowState();
    }
}

function updateModalArrowState() {
    const prevArrow = document.getElementById('modal-prev-arrow');
    const nextArrow = document.getElementById('modal-next-arrow');
    
    if (prevArrow) {
        prevArrow.style.opacity = currentScreenshotIndex === 0 ? '0.2' : '1';
        prevArrow.style.pointerEvents = currentScreenshotIndex === 0 ? 'none' : 'auto';
    }
    
    if (nextArrow) {
        nextArrow.style.opacity = currentScreenshotIndex >= allScreenshots.length - 1 ? '0.2' : '1';
        nextArrow.style.pointerEvents = currentScreenshotIndex >= allScreenshots.length - 1 ? 'none' : 'auto';
    }
}

// Modal keyboard shortcuts
document.addEventListener('keydown', (e) => {
    const modal = document.getElementById('screenshot-modal');
    if (modal && !modal.classList.contains('hidden')) {
        if (e.key === 'ArrowLeft') {
            modalPrevScreenshot();
        } else if (e.key === 'ArrowRight') {
            modalNextScreenshot();
        } else if (e.key === 'Escape') {
            closeScreenshotModal();
        }
    }
});

// Modal swipe gestures
let modalTouchStartX = 0;
let modalTouchEndX = 0;

function handleModalSwipe() {
    if (modalTouchStartX - modalTouchEndX > 50) {
        // Swiped left - go to next screenshot
        modalNextScreenshot();
    } else if (modalTouchEndX - modalTouchStartX > 50) {
        // Swiped right - go to previous screenshot
        modalPrevScreenshot();
    }
}

document.addEventListener('touchstart', (e) => {
    const modal = document.getElementById('screenshot-modal');
    if (modal && !modal.classList.contains('hidden')) {
        modalTouchStartX = e.changedTouches[0].screenX;
    }
}, false);

document.addEventListener('touchend', (e) => {
    const modal = document.getElementById('screenshot-modal');
    if (modal && !modal.classList.contains('hidden')) {
        modalTouchEndX = e.changedTouches[0].screenX;
        handleModalSwipe();
    }
}, false);

// Instructions Accordion
function toggleInstructions(platform) {
    const content = document.getElementById(`content-${platform}`);
    const icon = document.getElementById(`icon-${platform}`);
    
    if (!content) return;
    
    const isHidden = content.classList.contains('hidden');
    
    // Close all other instructions
    document.querySelectorAll('.instructions-content').forEach(el => {
        if (el.id !== `content-${platform}`) {
            el.classList.add('hidden');
            el.style.maxHeight = '0';
        }
    });
    
    // Update all icons
    document.querySelectorAll('[id^="icon-"]').forEach(el => {
        if (el.id !== `icon-${platform}`) {
            el.textContent = 'expand_more';
        }
    });
    
    // Toggle current
    if (isHidden) {
        content.classList.remove('hidden');
        setTimeout(() => {
            content.style.maxHeight = content.scrollHeight + 'px';
        }, 10);
        icon.textContent = 'expand_less';
    } else {
        content.style.maxHeight = '0';
        setTimeout(() => {
            content.classList.add('hidden');
        }, 300);
        icon.textContent = 'expand_more';
    }
}
</script>
{% endblock %}