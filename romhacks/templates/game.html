{% extends 'base.html' %}

{% block title %}{{ game.title }} ({{ game.console }}) ROM Hack â€” Patch, Download, How to Install | ROMHACKS.NET{% endblock %}

{% block og_type %}article{% endblock %}
{% block meta_image %}{{ game.image_url }}{% endblock %}
{% block meta_description %}{{ game.title }} {{ game.console }} ROM hack by {{ game.author }}. Features: {{ game.description[:120] or 'Discover this fan-made modification' }}{% if game.features %} Includes {{ game.features[0] }}{% endif %}. Download patch & patch locally in your browser.{% endblock %}
{% block meta_keywords %}{{ game.title }}, ROM hack, {{ game.base_game }}, {{ game.console }}, patch download, how to install, {{ game.author }}{% endblock %}

{% block json_ld %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "VideoGame",
    "name": {{ (game.title or '') | tojson }},
    "description": {{ (game.description or '') | tojson }},
    "url": {{ url_for('game_page', game_id=game.id, _external=True) | tojson }},
    "image": [{{ (game.image_url or '') | tojson }}{% if game.screenshots %},{{ game.screenshots[0] | tojson }}{% endif %}],
    "author": {
        "@type": "Person",
        "name": {{ (game.author or 'Unknown') | tojson }}
    },
    "creator": {
        "@type": "Person",
        "name": {{ (game.author or 'Unknown') | tojson }}
    },
    "datePublished": {{ (game.release_date or '') | tojson }},
    "version": {{ (game.version or '') | tojson }},
    "isBasedOn": {
        "@type": "VideoGame",
        "name": {{ (game.base_game or '') | tojson }},
        "platform": {{ (game.console or '') | tojson }}
    },
    "platform": {{ (game.console or '') | tojson }},
    "applicationCategory": "Game",
    "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD",
        "availability": "https://schema.org/InStock"
    }
    {% if game.features %},
    "keywords": {{ (game.features | join(', ')) | tojson }}
    {% endif %}
}
</script>
{% endblock %}

{% block content %}
<div class="flex flex-col gap-6 md:gap-8 max-w-6xl mx-auto">
    <div class="relative min-h-[280px] md:h-[380px] rounded-2xl overflow-hidden border border-gray-700/50 shadow-2xl bg-gradient-to-br from-gray-800 to-gray-900">
        <img src="{{ game.image_url }}" loading="lazy" referrerpolicy="no-referrer" class="w-full h-full object-contain object-center opacity-40" alt="{{ game.title }} - {{ game.base_game }} ROM Hack Cover Art" decoding="async">
        <div class="absolute inset-0 bg-gradient-to-t from-[#050507] to-transparent"></div>
        {% if game.dev_stage %}
        <div class="absolute top-4 right-4 z-10">
            {% set s = game.dev_stage|lower %}
            {% set status_cls = '' %}
            {% set status_icon = 'construction' %}
            
            {% if 'complete' in s or 'final' in s or 'stable' in s or 'finished' in s %}
                {% set status_cls = 'status-complete' %}
                {% set status_icon = 'verified' %}
            {% elif 'alpha' in s %}
                {% set status_cls = 'status-alpha' %}
                {% set status_icon = 'science' %}
            {% elif 'demo' in s %}
                {% set status_cls = 'status-demo' %}
                {% set status_icon = 'gamepad' %}
            {% elif 'wip' in s %}
                {% set status_cls = 'status-wip' %}
                {% set status_icon = 'handyman' %}
            {% endif %}

            <div class="dev-status-modern {{ status_cls }}">
                <span class="material-symbols-outlined">{{ status_icon }}</span>
                <span>{{ game.dev_stage }}</span>
            </div>
        </div>
        {% endif %}
        <div class="absolute bottom-0 left-0 right-0 p-4 md:p-8">
            <div class="flex items-end justify-between">
                <div>
                    <div class="flex flex-wrap items-center gap-1.5 md:gap-4 mb-3 md:mb-4">
                        {% if game.consoles %}
                            {% for c in game.consoles %}
                            <span class="{{ styles.get(c, styles['default']) }} text-[10px] font-bold px-2 md:px-3 py-1 rounded-md border uppercase bg-opacity-80">{{ c }}</span>
                            {% endfor %}
                        {% else %}
                            <span class="{{ styles.get(game.console, styles['default']) }} text-[10px] font-bold px-2 md:px-3 py-1 rounded-md border uppercase bg-opacity-80">{{ game.console }}</span>
                        {% endif %}
                        <span class="text-xs font-mono text-gray-400 border border-gray-700 px-2 py-1 bg-black/50">Released: {{ game.release_date[:4] if game.release_date else '' }}</span>
                    </div>
                    <h1 class="text-2xl sm:text-3xl md:text-5xl font-bold text-white pixel-font mb-4 md:mb-6">{{ game.title }}</h1>
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
                        <div class="border-l-2 border-blue-400 pl-3">
                            <div class="text-xs text-gray-400 uppercase font-bold tracking-wider">By {{ game.author }}</div>
                        </div>
                        <div class="border-l-2 border-blue-400 pl-3">
                            <div class="text-xs text-gray-400 uppercase font-bold tracking-wider">Latest Version</div>
                            <div class="text-base md:text-lg text-white font-mono font-semibold">{{ game.version }}</div>
                        </div>
                    </div>
                </div>
                {% if social_links %}
                <div class="flex flex-col gap-2">
                    {% for link in social_links %}
                    <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center w-10 h-10 rounded-lg bg-gray-800/50 border border-gray-700/50 hover:border-blue-400/50 hover:bg-gray-800 transition-all group" title="{{ link.type|replace('_', ' ')|title }}">
                        {% if link.type == 'twitter' %}
                        <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-400 transition-colors" fill="currentColor" viewBox="0 0 24 24"><path d="M23 3a10.9 10.9 0 01-3.14 1.53 4.48 4.48 0 00-7.86 3v1A10.66 10.66 0 013 4s-4 9 5 13a11.64 11.64 0 01-7 2s9 5 20 5a9.5 9.5 0 00-9-5.5c4.75 2.25 7-7 7-7a4.5 4.5 0 01-4.5-4.5"/></svg>
                        {% elif link.type == 'discord' %}
                        <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-400 transition-colors" fill="currentColor" viewBox="0 0 24 24"><path d="M20.317 4.369a19.791 19.791 0 00-4.885-1.515.074.074 0 00-.079.037c-.211.375-.445.864-.607 1.25a18.27 18.27 0 00-5.487 0c-.162-.386-.395-.875-.607-1.25a.077.077 0 00-.079-.037A19.736 19.736 0 003.677 4.37a.07.07 0 00-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 00.031.057 19.9 19.9 0 005.993 3.03.08.08 0 00.087-.027c.461-.63.873-1.295 1.226-1.994a.076.076 0 00-.042-.106 13.107 13.107 0 01-1.872-.892.077.077 0 00-.008-.128 10.72 10.72 0 00.372-.294.075.075 0 00.076-.01c3.928 1.793 8.18 1.793 12.062 0a.075.075 0 00.076.009c.12.098.246.198.373.294a.077.077 0 00-.006.127 12.299 12.299 0 01-1.873.892.076.076 0 00-.041.107c.36.699.772 1.365 1.225 1.994a.08.08 0 00.087.028 19.86 19.86 0 006.002-3.03.077.077 0 00.032-.056c.5-4.506.8-8.987.111-13.374a.07.07 0 00-.031-.027zM8.02 15.33c-1.183 0-2.157-.965-2.157-2.156 0-1.193.964-2.157 2.157-2.157 1.193 0 2.156.964 2.156 2.157 0 1.19-.963 2.156-2.156 2.156zm7.975 0c-1.183 0-2.157-.965-2.157-2.156 0-1.193.964-2.157 2.157-2.157 1.193 0 2.157.964 2.157 2.157 0 1.19-.964 2.156-2.157 2.156z"/></svg>
                        {% elif link.type == 'github' %}
                        <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-400 transition-colors" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v 3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                        {% elif link.type == 'website' %}
                        <span class="material-symbols-outlined text-lg text-gray-400 group-hover:text-blue-400 transition-colors">language</span>
                        {% else %}
                        <span class="material-symbols-outlined text-lg text-gray-400 group-hover:text-blue-400 transition-colors">language</span>
                        {% endif %}
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Overview Section -->
    <section class="mb-4">
        <h3 class="text-xl font-bold text-white mb-4 border-b border-gray-700/50 pb-2">Overview</h3>
        <p class="text-gray-300 leading-relaxed text-sm">{{ game.description }}</p>
    </section>

    <!-- Screenshots and Info Section -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 no-crt-filter">
        <!-- Screenshots on Left (if available) -->
        {% if game.screenshots %}
        <div class="lg:col-span-2 space-y-4 order-1 lg:order-1">
            <h3 class="text-xl font-bold text-white pixel-font flex items-center gap-2">
                <span class="material-symbols-outlined text-blue-500">photo_library</span> Screenshots
            </h3>
            <!-- Main Screenshot Display -->
            <div class="relative rounded-xl overflow-hidden border border-gray-700/50 bg-black/20 shadow-lg aspect-video group cursor-pointer" onclick="openScreenshotModal(currentScreenshotIndex)">
                <img id="main-screenshot" src="{{ game.screenshots[0] }}" loading="lazy" referrerpolicy="no-referrer" class="w-full h-full object-contain" alt="{{ game.title }} Screenshot" decoding="async">
                
                <!-- Navigation Arrows Overlay -->
                {% if game.screenshots|length > 1 %}
                <button onclick="selectScreenshot(currentScreenshotIndex - 1); event.stopPropagation();" class="absolute left-4 top-1/2 -translate-y-1/2 text-white/50 hover:text-white transition-all opacity-0 group-hover:opacity-100 p-2 z-20" id="prev-arrow">
                    <span class="material-symbols-outlined text-4xl">chevron_left</span>
                </button>
                <button onclick="selectScreenshot(currentScreenshotIndex + 1); event.stopPropagation();" class="absolute right-4 top-1/2 -translate-y-1/2 text-white/50 hover:text-white transition-all opacity-0 group-hover:opacity-100 p-2 z-20" id="next-arrow">
                    <span class="material-symbols-outlined text-4xl">chevron_right</span>
                </button>
                {% endif %}

            </div>
            
            <!-- Thumbnail Navigation -->
            {% if game.screenshots|length > 1 %}
            <div class="flex justify-center">
                <div class="overflow-hidden">
                    <div id="thumbnail-container" class="flex gap-2 transition-transform duration-300">
                        {% for shot in game.screenshots %}
                        <button 
                            class="flex-shrink-0 w-20 h-20 rounded border-2 transition-all cursor-pointer hover:border-blue-400 {% if loop.first %}border-blue-400{% else %}border-gray-700/50{% endif %} overflow-hidden"
                            onclick="selectScreenshot({{ loop.index0 }})"
                            title="Screenshot {{ loop.index }}">
                            <img src="{{ shot }}" loading="lazy" referrerpolicy="no-referrer" class="w-full h-full object-cover" alt="Screenshot {{ loop.index }}" decoding="async">
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Emulation Guide / Instructions (moved here to be directly below screenshots) -->
            {% if emulator_guide %}
            <section class="mt-8 order-3 lg:order-none">
                <h3 class="text-xl font-bold text-white mb-4 border-b border-gray-700/50 pb-2 flex items-center gap-2">
                    <span class="material-symbols-outlined text-blue-500">videogame_asset</span>
                    Emulation Guide for {{ emulator_guide.console_name }}
                </h3>
                
                {% if emulator_guide.guides %}
                <div class="space-y-3">
                    {% set platforms = ['windows', 'macos', 'linux', 'android', 'ios'] %}
                    {% set platform_names = {'windows': 'PC (Windows)', 'macos': 'macOS', 'linux': 'Linux', 'android': 'Android', 'ios': 'iOS'} %}
                    
                    {% for platform in platforms %}
                        {% set emulators = emulator_guide.guides.get(platform, []) %}
                        {% if emulators %}
                        <div class="border border-gray-700/50 rounded-lg overflow-hidden">
                            <button 
                                class="w-full px-6 py-4 bg-gray-900/50 hover:bg-gray-800/50 transition-all flex items-center justify-between group"
                                onclick="toggleEmulatorGuide('{{ platform }}')">
                                <div class="flex items-center gap-3">
                                    <!-- Platform Icon -->
                                    {% if platform == 'windows' %}
                                    <svg class="w-5 h-5 text-blue-400" fill="currentColor" viewBox="0 0 24 24"><path d="M3,12V6.75L9,5.43V11.91L3,12M20,3V11.75L10,11.9V5.21L20,3M3,13L9,13.09V19.9L3,18.75V13M20,13.25V22L10,20.09V13.1L20,13.25Z"/></svg>
                                    {% elif platform == 'macos' %}
                                    <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 24 24"><path d="M17.05 13.5c-.91 0-1.82-.33-2.5-.92.71-.71 1.17-1.71 1.17-2.83 0-2.13-1.75-3.87-3.87-3.87-1.13 0-2.13.47-2.84 1.17-.59-.68-.91-1.58-.91-2.5 0-2.13 1.75-3.87 3.87-3.87s3.87 1.75 3.87 3.87c0 .92-.33 1.83-.92 2.5.59.71 1.17 1.71 1.17 2.83 0 2.13-1.75 3.87-3.87 3.87m-4.5 4.87h9v1.5h-9zM12 0C5.37 0 0 5.37 0 12s5.37 12 12 12 12-5.37 12-12S18.63 0 12 0z"/></svg>
                                    {% elif platform == 'linux' %}
                                    <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12.504 0c-.155 0-.315.008-.48.021-4.226.333-3.105 4.807-3.17 6.298-.076 1.092-.3 1.953-1.05 3.02-.885 1.051-2.127 2.75-2.716 4.521-.278.832-.41 1.684-.287 2.489a.424.424 0 00-.11.135c-.26.268-.45.6-.663.839-.199.199-.485.267-.797.4-.313.136-.658.269-.864.68-.09.189-.136.394-.132.602 0 .199.027.4.055.536.058.399.116.728.04.97-.249.68-.28 1.145-.106 1.484.174.334.535.47.94.601.81.2 1.91.135 2.774.6.926.466 1.866.67 2.616.47.526-.116.97-.464 1.208-.946.587-.003 1.23-.269 2.26-.334.699-.058 1.574.267 2.577.2.025.134.063.198.114.333l.003.003c.391.778 1.113 1.132 1.884 1.071.771-.06 1.592-.536 2.257-1.306.631-.765 1.683-1.084 2.378-1.503.348-.199.629-.469.649-.853.023-.4-.2-.811-.714-1.376v-.097l-.003-.003c-.17-.2-.25-.535-.338-.926-.085-.401-.182-.786-.492-1.046h-.003c-.059-.054-.123-.067-.188-.135a.357.357 0 00-.19-.064c.431-1.278.264-2.55-.173-3.694-.533-1.41-1.465-2.638-2.175-3.483-.796-1.005-1.576-1.957-1.56-3.368.026-2.152.236-6.133-3.544-6.139zm.529 3.405h.013c.213 0 .396.062.584.198.19.135.33.332.438.533.105.259.158.459.166.724 0-.02.006-.04.006-.06v.105a.086.086 0 01-.004-.021l-.004-.024a1.807 1.807 0 01-.15.706.953.953 0 01-.213.335.71.71 0 00-.088-.042c-.104-.045-.198-.064-.284-.133a1.312 1.312 0 00-.22-.066c.05-.06.146-.133.183-.198.053-.128.082-.264.088-.402v-.02a1.21 1.21 0 00-.061-.4c-.045-.134-.101-.2-.183-.333-.084-.066-.167-.132-.267-.132h-.016c-.093 0-.176.03-.262.132a.8.8 0 00-.205.334 1.18 1.18 0 00-.09.4v.019c.002.089.008.179.02.267-.193-.067-.438-.135-.607-.202a1.635 1.635 0 01-.018-.2v-.02a1.772 1.772 0 01.15-.768c.082-.22.232-.406.43-.533a.985.985 0 01.594-.2zm-2.962.059h.036c.142 0 .27.048.399.135.146.129.264.288.344.465.09.199.14.4.153.667v.004c.007.134.006.2-.002.266v.08c-.03.007-.056.018-.083.024-.152.055-.274.135-.393.2.012-.09.013-.18.003-.267v-.015c-.012-.133-.04-.2-.082-.333a.613.613 0 00-.166-.267.248.248 0 00-.183-.064h-.021c-.071.006-.13.04-.186.132a.552.552 0 00-.12.27.944.944 0 00-.023.33v.015c.012.135.037.2.08.334.046.134.098.2.166.268.01.009.02.018.034.024-.07.057-.117.07-.176.136a.304.304 0 01-.131.068 2.62 2.62 0 01-.275-.402 1.772 1.772 0 01-.155-.667 1.759 1.759 0 01.08-.668 1.43 1.43 0 01.283-.535c.128-.133.26-.2.418-.2zm1.37 1.706c.332 0 .733.065 1.216.399.293.2.523.269 1.052.468h.003c.255.136.405.266.478.399v-.131a.571.571 0 01.016.47c-.123.31-.516.643-1.063.842v.002c-.268.135-.501.333-.775.465-.276.135-.588.292-1.012.267a1.139 1.139 0 01-.448-.067 3.566 3.566 0 01-.322-.198c-.195-.135-.363-.332-.612-.465v-.005h-.005c-.4-.246-.616-.512-.686-.71-.07-.268-.005-.47.193-.6.224-.135.38-.271.483-.336.104-.074.143-.102.176-.131h.002v-.003c.169-.202.436-.47.839-.601.139-.036.294-.065.466-.065zm2.8 2.142c.358 1.417 1.196 3.475 1.735 4.473.286.534.855 1.659 1.102 3.024.156-.005.33.018.513.064.646-1.671-.546-3.467-1.089-3.966-.22-.2-.232-.335-.123-.335.59.534 1.365 1.572 1.646 2.757.13.535.16 1.104.021 1.67.067.028.135.06.205.067 1.032.534 1.413.938 1.23 1.537v-.043c-.06-.003-.12 0-.18 0h-.016c.151-.467-.182-.825-1.065-1.224-.915-.4-1.646-.336-1.77.465-.008.043-.013.066-.018.135-.068.023-.139.053-.209.064-.43.268-.662.669-.793 1.187-.13.533-.17 1.156-.205 1.869v.003c-.02.334-.17.838-.319 1.35-1.5 1.072-3.58 1.538-5.348.334a2.645 2.645 0 00-.402-.533 1.45 1.45 0 00-.275-.333c.182 0 .338-.03.465-.067a.615.615 0 00.314-.334c.108-.267 0-.697-.345-1.163-.345-.467-.931-.995-1.788-1.521-.63-.4-.986-.87-1.15-1.396-.165-.534-.143-1.085-.015-1.645.245-1.07.873-2.11 1.274-2.763.107-.065.037.135-.408.974-.396.751-1.14 2.497-.122 3.854a8.123 8.123 0 01.647-2.876c.564-1.278 1.743-3.504 1.836-5.268.048.036.217.135.289.202.218.133.38.333.59.465.21.201.477.335.876.335.039.003.075.006.11.006.412 0 .73-.134.997-.268.29-.134.52-.334.74-.4h.005c.467-.135.835-.402 1.044-.7zm2.185 8.958c.037.6.343 1.245.882 1.377.588.134 1.434-.333 1.791-.765l.211-.01c.315-.007.577.01.847.268l.003.003c.208.199.305.53.391.876.085.4.154.78.409 1.066.486.527.645.906.636 1.14l.003-.007v.018l-.003-.012c-.015.262-.185.396-.498.595-.63.401-1.746.712-2.457 1.57-.618.737-1.37 1.14-2.036 1.191-.664.053-1.237-.2-1.574-.898l-.005-.003c-.21-.4-.12-1.025.056-1.69.176-.668.428-1.344.463-1.897.037-.714.076-1.335.195-1.814.12-.465.308-.797.641-.984l.045-.022zm-10.814.049h.01c.053 0 .105.005.157.014.376.055.706.333 1.023.752l.91 1.664.003.003c.243.533.754 1.064 1.189 1.637.434.598.77 1.131.729 1.57v.006c-.057.744-.48 1.148-1.125 1.294-.645.135-1.52.002-2.395-.464-.968-.536-2.118-.469-2.857-.602-.369-.066-.61-.2-.723-.4-.11-.2-.113-.602.123-1.23v-.004l.002-.003c.117-.334.03-.752-.027-1.118-.055-.401-.083-.71.043-.94.16-.334.396-.4.69-.533.294-.135.64-.202.915-.47h.002v-.002c.256-.268.445-.601.668-.838.19-.201.38-.336.663-.336zm7.159-9.074c-.435.201-.945.535-1.488.535-.542 0-.97-.267-1.28-.466-.154-.134-.28-.268-.373-.335-.164-.134-.144-.333-.074-.333.109.016.129.134.199.2.096.066.215.2.36.333.292.2.68.467 1.167.467.485 0 1.053-.267 1.398-.466.195-.135.445-.334.648-.467.156-.136.149-.267.279-.267.128.016.034.134-.147.332a8.097 8.097 0 01-.69.468zm-1.082-1.583V5.64c-.006-.02.013-.042.029-.05.074-.043.18-.027.26.004.063 0 .16.067.15.135-.006.049-.085.066-.135.066-.055 0-.092-.043-.141-.068-.052-.018-.146-.008-.163-.065zm-.551 0c-.02.058-.113.049-.166.066-.047.025-.086.068-.14.068-.05 0-.13-.02-.136-.068-.01-.066.088-.133.15-.133.08-.031.184-.047.259-.005.019.009.036.03.03.05v.02h.003z"/></svg>
                                    {% elif platform == 'android' %}
                                    <svg class="w-5 h-5 text-green-400" fill="currentColor" viewBox="0 0 24 24"><path d="M17.6 9.48l1.84-3.18c.16-.31.04-.69-.26-.85-.29-.15-.68-.04-.84.27l-1.88 3.24c-2.86-1.21-6.08-1.21-8.94 0L5.65 5.67c-.16-.31-.55-.42-.84-.27-.3.16-.42.54-.26.85L7.4 9.48c-3.5 2.55-5.4 6.2-5.4 10.52h17.98c0-4.32-1.9-7.97-5.38-10.52zM8 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm8 0c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
                                    {% elif platform == 'ios' %}
                                    <svg class="w-5 h-5 text-gray-300" fill="currentColor" viewBox="0 0 24 24"><path d="M17 2H7c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-5 18c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm5.5-3H6V4h11v13z"/></svg>
                                    {% endif %}
                                    <span class="font-bold text-white">{{ platform_names.get(platform, platform|title) }}</span>
                                </div>
                                <span class="material-symbols-outlined text-gray-400 group-hover:text-white transition-all transform text-lg font-bold" id="icon-{{ platform }}">expand_more</span>
                            </button>
                            
                            <!-- Emulators for this platform -->
                            <div 
                                id="guide-{{ platform }}"
                                class="emulator-guide hidden max-h-0 overflow-hidden transition-all duration-300">
                                <div class="space-y-4 px-6 py-4 bg-blue-900/20 border-t border-blue-500/30">
                                    {% for emulator in emulators %}
                                    <div class="border border-blue-500/20 rounded-lg p-4 bg-gray-800/30">
                                        <!-- Emulator Header with Logo and Link -->
                                        <div class="flex items-center justify-between mb-4">
                                            <div class="flex items-center gap-3">
                                                <!-- Emulator Logo -->
                                                {% if emulator.logo_svg %}
                                                <div class="w-12 h-12 rounded bg-gray-700 flex items-center justify-center flex-shrink-0">
                                                    {{ emulator.logo_svg|safe }}
                                                </div>
                                                {% endif %}
                                                <div>
                                                    <div class="font-bold text-blue-300 text-lg">{{ emulator.name }}</div>
                                                </div>
                                            </div>
                                            
                                            <!-- Link to emulator website -->
                                            {% if emulator.link %}
                                            <a href="{{ emulator.link }}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 transition-all shadow-lg shadow-blue-500/25 hover:shadow-blue-400/40 hover:scale-105 transform duration-200 group flex-shrink-0">
                                                <span class="material-symbols-outlined text-sm text-white">language</span>
                                                <span class="text-sm font-semibold text-white">Emulator Website</span>
                                                <span class="material-symbols-outlined text-sm text-white group-hover:translate-x-1 transition-transform">arrow_outward</span>
                                            </a>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Installation -->
                                        <div class="mb-3">
                                            <h5 class="text-xs font-bold text-blue-300 mb-1 flex items-center gap-1">
                                                <span class="material-symbols-outlined text-xs">download</span>
                                                Installation
                                            </h5>
                                            <p class="text-xs text-gray-300 leading-relaxed whitespace-pre-line ml-4">{{ emulator.installation }}</p>
                                        </div>
                                        
                                        <!-- Configuration -->
                                        <div>
                                            <h5 class="text-xs font-bold text-blue-300 mb-1 flex items-center gap-1">
                                                <span class="material-symbols-outlined text-xs">settings</span>
                                                Configuration
                                            </h5>
                                            <p class="text-xs text-gray-300 leading-relaxed whitespace-pre-line ml-4">{{ emulator.configuration }}</p>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
            </section>
            {% endif %}
        </div>
        {% else %}
        <!-- No screenshots - Empty left column -->
        <div class="lg:col-span-2"></div>
        {% endif %}

        <!-- Info Sidebar on Right -->
        <div class="lg:col-span-1 space-y-6 order-2 lg:order-2">
            <div class="bg-gray-900/50 border border-gray-700/50 p-6 rounded-xl sticky top-24 shadow-lg">
                <div class="mb-6">
                    <div class="text-xs text-gray-500 uppercase font-bold mb-1">Base Game</div>
                    <div class="text-sm text-gray-300">{{ game.base_game }}</div>
                    {% if game.version_region %}
                    <div class="text-xs text-gray-500 mt-2">Base ROM version required: <span class="text-gray-300">{{ game.version_region }}</span></div>
                    {% endif %}
                </div>


                
                {% if game.base_region or game.base_revision or game.base_header or game.base_checksum_crc32 or game.base_checksum_md5 or game.base_checksum_sha1 or game.patch_format or game.patch_output_ext %}
                <div class="mb-6 bg-black/30 p-4 rounded-lg border border-gray-700/50">
                    <div class="text-xs text-gray-500 uppercase font-bold mb-3">Base Game Requirements</div>
                    <div class="space-y-2 text-xs">
                        {% if game.base_region %}
                        <div><span class="text-gray-400">Region:</span> <span class="text-gray-200 font-mono">{{ game.base_region }}</span></div>
                        {% endif %}
                        {% if game.base_revision %}
                        <div><span class="text-gray-400">Revision:</span> <span class="text-gray-200 font-mono">{{ game.base_revision }}</span></div>
                        {% endif %}
                        {% if game.base_header %}
                        <div><span class="text-gray-400">Header:</span> <span class="text-gray-200 font-mono">{{ game.base_header }}</span></div>
                        {% endif %}
                        {% if game.base_checksum_crc32 %}
                        <div class="break-all"><span class="text-gray-400">CRC32:</span> <span class="text-gray-200 font-mono text-[10px]">{{ game.base_checksum_crc32 }}</span></div>
                        {% endif %}
                        {% if game.base_checksum_md5 %}
                        <div class="break-all"><span class="text-gray-400">MD5:</span> <span class="text-gray-200 font-mono text-[10px]">{{ game.base_checksum_md5 }}</span></div>
                        {% endif %}
                        {% if game.base_checksum_sha1 %}
                        <div class="break-all"><span class="text-gray-400">SHA-1:</span> <span class="text-gray-200 font-mono text-[10px]">{{ game.base_checksum_sha1 }}</span></div>
                        {% endif %}
                        {% if game.patch_format %}
                        <div><span class="text-gray-400">Patch Format:</span> <span class="text-gray-200 font-mono">{{ game.patch_format }}</span></div>
                        {% endif %}
                        {% if game.patch_output_ext %}
                        <div><span class="text-gray-400">Output Extension:</span> <span class="text-gray-200 font-mono">{{ game.patch_output_ext }}</span></div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                {% if game.instruction and game.instruction_text %}
                <div class="mb-6 bg-red-900/30 p-4 rounded-lg border border-red-700/50">
                    <div class="flex items-start gap-3 mb-2">
                        <span class="material-symbols-outlined text-red-400 text-lg flex-shrink-0 mt-0.5">warning</span>
                        <div>
                            <div class="text-xs text-red-300 uppercase font-bold mb-2">This game has special instructions!</div>
                            <p class="text-xs text-red-100 leading-relaxed whitespace-pre-wrap">{{ game.instruction_text }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <a href="{{ game.download_link }}" target="_blank" onclick="trackDownload('{{ game.id }}')" class="btn-retro w-full justify-center text-center py-4 mb-2">
                    {% if is_port %}
                        Download Port
                    {% else %}
                        Download Patch
                    {% endif %}
                </a>
                <p class="text-[10px] text-gray-500 text-center mb-4 italic">Redirects to official download page</p>
                
                <div class="flex items-center justify-between px-2 py-2 mb-4">
                    {% if not is_port %}
                    <a href="/patcher#faq" class="text-blue-400 text-xs hover:text-white transition-all font-semibold">What's a patch?</a>
                    {% endif %}
                    <span class="inline-flex items-center gap-2 text-[12px] font-mono text-gray-300">
                        <span class="material-symbols-outlined text-[14px] text-blue-400">download</span>
                        {{ download_count | default(0) | download_count_label }} downloads
                    </span>
                </div>

                {% if game.features %}
                <div class="border-t border-gray-800 pt-4 mt-4">
                    <div class="text-xs text-gray-500 uppercase font-bold mb-3">Key Features</div>
                    <ul class="space-y-2">
                        {% if game.online_play %}
                        <li class="flex items-center gap-2 text-xs text-green-300">
                            <span class="material-symbols-outlined text-green-400 text-sm">lan</span> 
                            Online Play
                        </li>
                        {% endif %}
                        {% for feature in game.features %}
                        <li class="flex items-center gap-2 text-xs text-gray-300">
                            <span class="material-symbols-outlined text-blue-500 text-sm">check_circle</span> 
                            {{ feature }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% elif game.online_play %}
                <div class="border-t border-gray-800 pt-4 mt-4">
                    <div class="text-xs text-gray-500 uppercase font-bold mb-3">Features</div>
                    <ul class="space-y-2">
                        <li class="flex items-center gap-2 text-xs text-green-300">
                            <span class="material-symbols-outlined text-green-400 text-sm">lan</span> 
                            Online Play
                        </li>
                    </ul>
                </div>
                {% endif %}
                
                <!-- Common Issues Tab -->
                {% if game.support_forum_url or game.discord_url or game.reddit_url or game.troubleshooting_url or game.rom_checker_url or game.wiki_url or social_links %}
                <div class="border border-gray-700/50 rounded-lg p-4 bg-gray-900/30 mt-4">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="material-symbols-outlined text-yellow-500 text-lg">help</span>
                        <h4 class="text-sm font-bold text-white">Need Help?</h4>
                    </div>
                    <div class="space-y-2 text-xs text-gray-400">
                        <p class="mb-2">Experiencing problems? Check out these resources:</p>
                        <div class="flex flex-col gap-2">
                            {% if game.troubleshooting_url %}
                            <a href="{{ game.troubleshooting_url }}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-blue-400 hover:text-blue-300 transition-all">
                                <span class="material-symbols-outlined text-sm">menu_book</span>
                                <span>Troubleshooting Guide / FAQ</span>
                            </a>
                            {% endif %}
                            {% if game.wiki_url %}
                            <a href="{{ game.wiki_url }}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-blue-400 hover:text-blue-300 transition-all">
                                <span class="material-symbols-outlined text-sm">menu_book</span>
                                <span>Wiki</span>
                            </a>
                            {% endif %}
                            {% if game.rom_checker_url %}
                            <a href="{{ game.rom_checker_url }}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-blue-400 hover:text-blue-300 transition-all">
                                <span class="material-symbols-outlined text-sm">verified</span>
                                <span>ROM Compatibility Checker</span>
                            </a>
                            {% endif %}
                            {% if game.support_forum_url %}
                            <a href="{{ game.support_forum_url }}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-blue-400 hover:text-blue-300 transition-all">
                                <span class="material-symbols-outlined text-sm">forum</span>
                                <span>Support Forum</span>
                            </a>
                            {% endif %}
                            {% if game.discord_url %}
                            <a href="{{ game.discord_url }}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-blue-400 hover:text-blue-300 transition-all">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M20.317 4.369a19.791 19.791 0 00-4.885-1.515.074.074 0 00-.079.037c-.211.375-.445.864-.607 1.25a18.27 18.27 0 00-5.487 0c-.162-.386-.395-.875-.607-1.25a.077.077 0 00-.079-.037A19.736 19.736 0 003.677 4.37a.07.07 0 00-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 00.031.057 19.9 19.9 0 005.993 3.03.08.08 0 00.087-.027c.461-.63.873-1.295 1.226-1.994a.076.076 0 00-.042-.106 13.107 13.107 0 01-1.872-.892.077.077 0 00-.008-.128 10.72 10.72 0 00.372-.294.075.075 0 00.076-.01c3.928 1.793 8.18 1.793 12.062 0a.075.075 0 00.076.009c.12.098.246.198.373.294a.077.077 0 00-.006.127 12.299 12.299 0 01-1.873.892.076.076 0 00-.041.107c.36.699.772 1.365 1.225 1.994a.08.08 0 00.087.028 19.86 19.86 0 006.002-3.03.077.077 0 00.032-.056c.5-5.094-.838-9.52-3.549-13.442a.06.06 0 00-.031-.028zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
                                <span>Discord Server</span>
                            </a>
                            {% endif %}
                            {% if game.reddit_url %}
                            <a href="{{ game.reddit_url }}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-blue-400 hover:text-blue-300 transition-all">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/></svg>
                                <span>Reddit Community</span>
                            </a>
                            {% endif %}
                            {% for link in social_links %}
                            {% if link.type == 'github' %}
                            <a href="{{ link.url }}/issues" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-blue-400 hover:text-blue-300 transition-all">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                                <span>Report Issues on GitHub</span>
                            </a>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <div class="border-t border-gray-800 pt-4 mt-4">
                    <p class="text-[10px] text-gray-500 mb-2">Have the base file?</p>
                    <a href="/patcher" class="block text-center text-blue-400 text-xs hover:text-white border border-blue-500/30 hover:border-blue-500 py-2 rounded-lg transition-all">
                        Go to Web Patcher
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Claim It Section -->
    <div class="mt-16 mb-12 bg-[#1a1a20] border border-gray-800/50 rounded-xl p-8 text-center max-w-6xl mx-auto">
        <h3 class="text-xl font-bold pixel-font text-white mb-2">Is this your project?</h3>
        <p class="text-gray-400 text-sm mb-4">Help us keep the database accurate and complete.</p>
        <div class="flex flex-col sm:flex-row gap-3 justify-center">
            <a href="{{ url_for('claim', game_id=game.id, title=game.title) }}" class="inline-flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-semibold transition-all">
                <span class="material-symbols-outlined text-base">verified_user</span>
                Claim it!
            </a>
            <a href="{{ url_for('contact', type='correction', title=game.title) }}" class="inline-flex items-center justify-center gap-2 bg-gray-700 hover:bg-gray-600 text-white px-6 py-2 rounded-lg text-sm font-semibold transition-all">
                <span class="material-symbols-outlined text-base">flag</span>
                Report Issue
            </a>
        </div>
    </div>

</div>

<!-- Screenshot Modal Lightbox -->
<div id="screenshot-modal" class="fixed inset-0 bg-black/90 hidden z-50 flex items-center justify-center p-4" onclick="if(event.target.id === 'screenshot-modal') closeScreenshotModal()">
    <button onclick="closeScreenshotModal()" class="absolute top-4 right-4 text-white/70 hover:text-white transition-all z-50">
        <span class="material-symbols-outlined text-4xl">close</span>
    </button>
    
    <div class="relative w-full h-full flex items-center justify-center" onclick="event.stopPropagation()">
        <img id="modal-screenshot" referrerpolicy="no-referrer" src="" class="max-w-full max-h-full object-contain" alt="Enlarged screenshot">
        
        <!-- Modal Navigation -->
        <button onclick="modalPrevScreenshot()" class="absolute left-4 top-1/2 -translate-y-1/2 text-white/50 hover:text-white transition-all p-3" id="modal-prev-arrow">
            <span class="material-symbols-outlined text-5xl">chevron_left</span>
        </button>
        <button onclick="modalNextScreenshot()" class="absolute right-4 top-1/2 -translate-y-1/2 text-white/50 hover:text-white transition-all p-3" id="modal-next-arrow">
            <span class="material-symbols-outlined text-5xl">chevron_right</span>
        </button>
        
        <!-- Screenshot Counter -->
        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-black/50 px-4 py-2 rounded-lg text-white/70 text-sm font-mono">
            <span id="modal-counter">1</span> / <span id="modal-total">1</span>
        </div>
    </div>
</div>

<!-- Screenshot Navigation Scripts -->
<script>
const allScreenshots = [
    {% for shot in game.screenshots %}'{{ shot }}'{{ "," if not loop.last }}{% endfor %}
];

let currentScreenshotIndex = 0;
const thumbnailWidth = 88; // width (80px) + gap (8px)

function selectScreenshot(index) {
    // Clamp index to valid range
    index = Math.max(0, Math.min(index, allScreenshots.length - 1));
    currentScreenshotIndex = index;
    
    const mainImg = document.getElementById('main-screenshot');
    if (mainImg) {
        mainImg.src = allScreenshots[index];
    }
    
    // Update thumbnail borders
    document.querySelectorAll('#thumbnail-container button').forEach((btn, i) => {
        btn.classList.toggle('border-blue-400', i === index);
        btn.classList.toggle('border-gray-700/50', i !== index);
    });
    
    // Auto-scroll to show selected thumbnail
    ensureThumbbnailVisible(index);
    updateArrowState();
}

function scrollThumbnails(direction) {
    const container = document.getElementById('thumbnail-container');
    if (!container) return;
    const scrollAmount = thumbnailWidth * 3; // Scroll by 3 thumbnails
    container.scrollBy({ left: direction * scrollAmount, behavior: 'smooth' });
}

function ensureThumbbnailVisible(index) {
    const container = document.getElementById('thumbnail-container');
    if (!container) return;
    const button = container.querySelector(`button:nth-child(${index + 1})`);
    if (button) {
        button.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    }
}

function updateArrowState() {
    const prevArrow = document.getElementById('prev-arrow');
    const nextArrow = document.getElementById('next-arrow');
    
    if (prevArrow) {
        prevArrow.style.opacity = currentScreenshotIndex === 0 ? '0' : '1';
        prevArrow.style.pointerEvents = currentScreenshotIndex === 0 ? 'none' : 'auto';
    }
    
    if (nextArrow) {
        nextArrow.style.opacity = currentScreenshotIndex >= allScreenshots.length - 1 ? '0' : '1';
        nextArrow.style.pointerEvents = currentScreenshotIndex >= allScreenshots.length - 1 ? 'none' : 'auto';
    }
}

// Keyboard navigation
document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft' && currentScreenshotIndex > 0) {
        selectScreenshot(currentScreenshotIndex - 1);
    } else if (e.key === 'ArrowRight' && currentScreenshotIndex < allScreenshots.length - 1) {
        selectScreenshot(currentScreenshotIndex + 1);
    }
});

// Update arrow states on load and resize
window.addEventListener('load', updateArrowState);
window.addEventListener('resize', updateArrowState);

// Swipe gesture for screenshot navigation
let touchStartX = 0;
let touchEndX = 0;

function handleSwipe(container) {
    if (touchStartX - touchEndX > 50) {
        // Swiped left - go to next screenshot
        if (currentScreenshotIndex < allScreenshots.length - 1) {
            selectScreenshot(currentScreenshotIndex + 1);
        }
    } else if (touchEndX - touchStartX > 50) {
        // Swiped right - go to previous screenshot
        if (currentScreenshotIndex > 0) {
            selectScreenshot(currentScreenshotIndex - 1);
        }
    }
}

document.addEventListener('touchstart', (e) => {
    const screenshotContainer = document.getElementById('main-screenshot');
    if (!screenshotContainer) return;
    const mainContainer = screenshotContainer.closest('.relative');
    if (mainContainer && mainContainer.contains(e.target)) {
        touchStartX = e.changedTouches[0].screenX;
    }
}, false);

document.addEventListener('touchend', (e) => {
    const screenshotContainer = document.getElementById('main-screenshot');
    if (!screenshotContainer) return;
    const mainContainer = screenshotContainer.closest('.relative');
    if (mainContainer && mainContainer.contains(e.target)) {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe(mainContainer);
    }
}, false);

// Screenshot Modal Functions
function openScreenshotModal(index) {
    const modal = document.getElementById('screenshot-modal');
    const modalImg = document.getElementById('modal-screenshot');
    const counter = document.getElementById('modal-counter');
    const total = document.getElementById('modal-total');
    
    if (modal && modalImg && allScreenshots.length > 0) {
        currentScreenshotIndex = Math.max(0, Math.min(index, allScreenshots.length - 1));
        modalImg.src = allScreenshots[currentScreenshotIndex];
        counter.textContent = currentScreenshotIndex + 1;
        total.textContent = allScreenshots.length;
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        updateModalArrowState();
    }
}

function closeScreenshotModal(event) {
    const modal = document.getElementById('screenshot-modal');
    if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
    }
}

function modalNextScreenshot() {
    if (currentScreenshotIndex < allScreenshots.length - 1) {
        currentScreenshotIndex++;
        updateModalImage();
    }
}

function modalPrevScreenshot() {
    if (currentScreenshotIndex > 0) {
        currentScreenshotIndex--;
        updateModalImage();
    }
}

function updateModalImage() {
    const modalImg = document.getElementById('modal-screenshot');
    const counter = document.getElementById('modal-counter');
    
    if (modalImg && allScreenshots.length > 0) {
        modalImg.src = allScreenshots[currentScreenshotIndex];
        counter.textContent = currentScreenshotIndex + 1;
        updateModalArrowState();
    }
}

function updateModalArrowState() {
    const prevArrow = document.getElementById('modal-prev-arrow');
    const nextArrow = document.getElementById('modal-next-arrow');
    
    if (prevArrow) {
        prevArrow.style.opacity = currentScreenshotIndex === 0 ? '0.2' : '1';
        prevArrow.style.pointerEvents = currentScreenshotIndex === 0 ? 'none' : 'auto';
    }
    
    if (nextArrow) {
        nextArrow.style.opacity = currentScreenshotIndex >= allScreenshots.length - 1 ? '0.2' : '1';
        nextArrow.style.pointerEvents = currentScreenshotIndex >= allScreenshots.length - 1 ? 'none' : 'auto';
    }
}

// Modal keyboard shortcuts
document.addEventListener('keydown', (e) => {
    const modal = document.getElementById('screenshot-modal');
    if (modal && !modal.classList.contains('hidden')) {
        if (e.key === 'ArrowLeft') {
            modalPrevScreenshot();
        } else if (e.key === 'ArrowRight') {
            modalNextScreenshot();
        } else if (e.key === 'Escape') {
            closeScreenshotModal();
        }
    }
});

// Modal swipe gestures
let modalTouchStartX = 0;
let modalTouchEndX = 0;

function handleModalSwipe() {
    if (modalTouchStartX - modalTouchEndX > 50) {
        // Swiped left - go to next screenshot
        modalNextScreenshot();
    } else if (modalTouchEndX - modalTouchStartX > 50) {
        // Swiped right - go to previous screenshot
        modalPrevScreenshot();
    }
}

document.addEventListener('touchstart', (e) => {
    const modal = document.getElementById('screenshot-modal');
    if (modal && !modal.classList.contains('hidden')) {
        modalTouchStartX = e.changedTouches[0].screenX;
    }
}, false);

document.addEventListener('touchend', (e) => {
    const modal = document.getElementById('screenshot-modal');
    if (modal && !modal.classList.contains('hidden')) {
        modalTouchEndX = e.changedTouches[0].screenX;
        handleModalSwipe();
    }
}, false);

// Instructions Accordion
function toggleInstructions(platform) {
    const content = document.getElementById(`content-${platform}`);
    const icon = document.getElementById(`icon-${platform}`);
    
    if (!content) return;
    
    const isHidden = content.classList.contains('hidden');
    
    // Close all other instructions
    document.querySelectorAll('.instructions-content').forEach(el => {
        if (el.id !== `content-${platform}`) {
            el.classList.add('hidden');
            el.style.maxHeight = '0';
        }
    });
    
    // Update all icons
    document.querySelectorAll('[id^="icon-"]').forEach(el => {
        if (el.id !== `icon-${platform}`) {
            el.textContent = 'expand_more';
        }
    });
    
    // Toggle current
    if (isHidden) {
        content.classList.remove('hidden');
        setTimeout(() => {
            content.style.maxHeight = content.scrollHeight + 'px';
        }, 10);
        icon.textContent = 'expand_less';
    } else {
        content.style.maxHeight = '0';
        setTimeout(() => {
            content.classList.add('hidden');
        }, 300);
        icon.textContent = 'expand_more';
    }
}

// Emulator Guide Accordion
function toggleEmulatorGuide(platform) {
    const content = document.getElementById(`guide-${platform}`);
    const icon = document.getElementById(`icon-${platform}`);
    
    if (!content) return;
    
    const isHidden = content.classList.contains('hidden');
    
    // Close all other guides
    document.querySelectorAll('.emulator-guide').forEach(el => {
        if (el.id !== `guide-${platform}`) {
            el.classList.add('hidden');
            el.style.maxHeight = '0';
        }
    });
    
    // Update all icons for emulator guides only
    document.querySelectorAll('.emulator-guide').forEach(el => {
        const guidePlatform = el.id.replace('guide-', '');
        const otherIcon = document.getElementById(`icon-${guidePlatform}`);
        if (otherIcon && guidePlatform !== platform) {
            otherIcon.textContent = 'expand_more';
        }
    });
    
    // Toggle current
    if (isHidden) {
        content.classList.remove('hidden');
        setTimeout(() => {
            content.style.maxHeight = content.scrollHeight + 'px';
        }, 10);
        if (icon) icon.textContent = 'expand_less';
    } else {
        content.style.maxHeight = '0';
        setTimeout(() => {
            content.classList.add('hidden');
        }, 300);
        if (icon) icon.textContent = 'expand_more';
    }
}
</script>
{% endblock %}