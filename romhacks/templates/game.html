{% extends 'base.html' %}

{% block title %}{{ game.title }} ({{ game.console }}) ROM Hack — Patch, Download, How to Install | ROMHACKS.NET{% endblock %}

{% block og_type %}article{% endblock %}
{% block meta_image %}{{ game.image_url }}{% endblock %}
{% block meta_description %}{{ game.title }} {{ game.console }} ROM hack by {{ game.author }}. Features: {{ game.description[:120] or 'Discover this fan-made modification' }}{% if game.features %} Includes {{ game.features[0] }}{% endif %}. Download patch & patch locally in your browser.{% endblock %}
{% block meta_keywords %}{{ game.title }}, ROM hack, {{ game.base_game }}, {{ game.console }}, patch download, how to install, {{ game.author }}{% endblock %}

{% block json_ld %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "VideoGame",
    "name": {{ (game.title or '') | tojson }},
    "description": {{ (game.description or '') | tojson }},
    "url": {{ url_for('game_page', game_id=game.id, _external=True) | tojson }},
    "image": [{{ (game.image_url or '') | tojson }}{% if game.screenshots %},{{ game.screenshots[0] | tojson }}{% endif %}],
    "author": {
        "@type": "Person",
        "name": {{ (game.author or 'Unknown') | tojson }}
    },
    "creator": {
        "@type": "Person",
        "name": {{ (game.author or 'Unknown') | tojson }}
    },
    "datePublished": {{ (game.release_date or '') | tojson }},
    "version": {{ (game.version or '') | tojson }},
    "isBasedOn": {
        "@type": "VideoGame",
        "name": {{ (game.base_game or '') | tojson }},
        "platform": {{ (game.console or '') | tojson }}
    },
    "platform": {{ (game.console or '') | tojson }},
    "applicationCategory": "Game",
    "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD",
        "availability": "https://schema.org/InStock"
    }
    {% if game.features %},
    "keywords": {{ (game.features | join(', ')) | tojson }}
    {% endif %}
}
</script>
{% endblock %}

{% block content %}
<div class="flex flex-col gap-6 md:gap-8 max-w-6xl mx-auto">
    <div class="relative min-h-[280px] md:h-[380px] rounded-2xl overflow-hidden border border-gray-700/50 shadow-2xl bg-gradient-to-br from-gray-800 to-gray-900">
        <img src="{{ game.image_url }}" loading="lazy" referrerpolicy="no-referrer" class="w-full h-full object-contain object-center opacity-40" alt="{{ game.title }} - {{ game.base_game }} ROM Hack Cover Art" decoding="async">
        <div class="absolute inset-0 bg-gradient-to-t from-[#050507] to-transparent"></div>
        {% if game.dev_stage %}
        <div class="absolute top-4 right-4 z-10">
            {% set s = game.dev_stage|lower %}
            {% set status_cls = '' %}
            {% set status_icon = 'construction' %}
            
            {% if 'complete' in s or 'final' in s or 'stable' in s or 'finished' in s %}
                {% set status_cls = 'status-complete' %}
                {% set status_icon = 'verified' %}
            {% elif 'alpha' in s %}
                {% set status_cls = 'status-alpha' %}
                {% set status_icon = 'science' %}
            {% elif 'demo' in s %}
                {% set status_cls = 'status-demo' %}
                {% set status_icon = 'gamepad' %}
            {% elif 'wip' in s %}
                {% set status_cls = 'status-wip' %}
                {% set status_icon = 'handyman' %}
            {% endif %}

            <div class="dev-status-modern {{ status_cls }}">
                <span class="material-symbols-outlined">{{ status_icon }}</span>
                <span>{{ game.dev_stage }}</span>
            </div>
        </div>
        {% endif %}
        <div class="absolute bottom-0 left-0 right-0 p-4 md:p-8">
            <div class="flex items-end justify-between">
                <div>
                    <div class="flex flex-wrap items-center gap-1.5 md:gap-4 mb-3 md:mb-4">
                        {% if game.consoles %}
                            {% for c in game.consoles %}
                            <span class="{{ styles.get(c, styles['default']) }} text-[10px] font-bold px-2 md:px-3 py-1 rounded-md border uppercase bg-opacity-80">{{ c }}</span>
                            {% endfor %}
                        {% else %}
                            <span class="{{ styles.get(game.console | normalize_console, styles['default']) }} text-[10px] font-bold px-2 md:px-3 py-1 rounded-md border uppercase bg-opacity-80">{{ game.console }}</span>
                        {% endif %}
                        <span class="text-xs font-mono text-gray-400 border border-gray-700 px-2 py-1 bg-black/50">Released: {{ game.release_date[:4] if game.release_date else '' }}</span>
                    </div>
                    <h1 class="text-2xl sm:text-3xl md:text-5xl font-bold text-white pixel-font mb-4 md:mb-6">{{ game.title }}</h1>
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
                        <div class="border-l-2 border-blue-400 pl-3">
                            <div class="text-xs text-gray-400 uppercase font-bold tracking-wider">By {{ game.author }}</div>
                        </div>
                        <div class="border-l-2 border-blue-400 pl-3">
                            <div class="text-xs text-gray-400 uppercase font-bold tracking-wider">Latest Version</div>
                            <div class="text-base md:text-lg text-white font-mono font-semibold">{{ game.version }}</div>
                        </div>
                    </div>
                </div>
                {% if social_links %}
                <div class="flex flex-col gap-2">
                    {% for link in social_links %}
                    <a href="{{ link.url }}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center justify-center {{ 'px-4 gap-2' if link.type == 'website' else 'w-10' }} h-10 rounded-lg bg-gray-800/50 border border-gray-700/50 hover:border-blue-400/50 hover:bg-gray-800 transition-all group" title="{{ link.type|replace('_', ' ')|title }}">
                        {% if link.type == 'twitter' %}
                        <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-400 transition-colors" fill="currentColor" viewBox="0 0 24 24"><path d="M23 3a10.9 10.9 0 01-3.14 1.53 4.48 4.48 0 00-7.86 3v1A10.66 10.66 0 013 4s-4 9 5 13a11.64 11.64 0 01-7 2s9 5 20 5a9.5 9.5 0 00-9-5.5c4.75 2.25 7-7 7-7a4.5 4.5 0 01-4.5-4.5"/></svg>
                        {% elif link.type == 'discord' %}
                        <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-400 transition-colors" fill="currentColor" viewBox="0 0 24 24"><path d="M20.317 4.369a19.791 19.791 0 00-4.885-1.515.074.074 0 00-.079.037c-.211.375-.445.864-.607 1.25a18.27 18.27 0 00-5.487 0c-.162-.386-.395-.875-.607-1.25a.077.077 0 00-.079-.037A19.736 19.736 0 003.677 4.37a.07.07 0 00-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 00.031.057 19.9 19.9 0 005.993 3.03.08.08 0 00.087-.027c.461-.63.873-1.295 1.226-1.994a.076.076 0 00-.042-.106 13.107 13.107 0 01-1.872-.892.077.077 0 00-.008-.128 10.72 10.72 0 00.372-.294.075.075 0 00.076-.01c3.928 1.793 8.18 1.793 12.062 0a.075.075 0 00.076.009c.12.098.246.198.373.294a.077.077 0 00-.006.127 12.299 12.299 0 01-1.873.892.076.076 0 00-.041.107c.36.699.772 1.365 1.225 1.994a.08.08 0 00.087.028 19.86 19.86 0 006.002-3.03.077.077 0 00.032-.056c.5-4.506.8-8.987.111-13.374a.07.07 0 00-.031-.027zM8.02 15.33c-1.183 0-2.157-.965-2.157-2.156 0-1.193.964-2.157 2.157-2.157 1.193 0 2.156.964 2.156 2.157 0 1.19-.963 2.156-2.156 2.156zm7.975 0c-1.183 0-2.157-.965-2.157-2.156 0-1.193.964-2.157 2.157-2.157 1.193 0 2.157.964 2.157 2.157 0 1.19-.964 2.156-2.157 2.156z"/></svg>
                        {% elif link.type == 'github' %}
                        <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-400 transition-colors" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v 3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                        {% elif link.type == 'website' %}
                        <span class="material-symbols-outlined text-2xl text-gray-400 group-hover:text-blue-400 transition-colors">language</span>
                        <span class="text-xs font-bold text-gray-300 group-hover:text-white">Project Website</span>
                        {% else %}
                        <span class="material-symbols-outlined text-lg text-gray-400 group-hover:text-blue-400 transition-colors">language</span>
                        {% endif %}
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Overview Section -->
    <section class="mb-4">
        <h3 class="text-xl font-bold text-white mb-4 border-b border-gray-700/50 pb-2">Overview</h3>
        <p class="text-gray-300 leading-relaxed text-sm">{{ game.description }}</p>
    </section>

    <!-- Screenshots and Info Section -->
    <div class="flex flex-col lg:flex-row gap-8 no-crt-filter">
        <!-- LEFT COLUMN: Screenshots + Emulation Guide -->
        <div class="flex-1 min-w-0 space-y-8">
            <!-- Screenshots on Left (if available) -->
            {% if game.screenshots %}
            <div class="space-y-4">
                <h3 class="text-xl font-bold text-white pixel-font flex items-center gap-2">
                    <span class="material-symbols-outlined text-blue-500">photo_library</span> Screenshots
                </h3>
            <!-- Main Screenshot Display -->
            <div id="main-screenshot-container" class="relative rounded-xl overflow-hidden border border-gray-700/50 bg-black/20 shadow-lg aspect-video group cursor-pointer">
                <img id="main-screenshot" src="{{ game.screenshots[0] }}" loading="lazy" referrerpolicy="no-referrer" class="w-full h-full object-contain" alt="{{ game.title }} Screenshot" decoding="async">
                
                <!-- Navigation Arrows Overlay -->
                {% if game.screenshots|length > 1 %}
                <button class="nav-arrow-prev absolute left-4 top-1/2 -translate-y-1/2 text-white/50 hover:text-white transition-all opacity-0 group-hover:opacity-100 p-2 z-20" id="prev-arrow">
                    <span class="material-symbols-outlined text-4xl">chevron_left</span>
                </button>
                <button class="nav-arrow-next absolute right-4 top-1/2 -translate-y-1/2 text-white/50 hover:text-white transition-all opacity-0 group-hover:opacity-100 p-2 z-20" id="next-arrow">
                    <span class="material-symbols-outlined text-4xl">chevron_right</span>
                </button>
                {% endif %}

            </div>
            
            <!-- Thumbnail Navigation -->
            {% if game.screenshots|length > 1 %}
            <div class="flex justify-center">
                <div class="overflow-hidden">
                    <div id="thumbnail-container" class="flex gap-2 transition-transform duration-300">
                        {% for shot in game.screenshots %}
                        <button 
                            class="screenshot-thumbnail flex-shrink-0 w-20 h-20 rounded border-2 transition-all cursor-pointer hover:border-blue-400 {% if loop.first %}border-blue-400{% else %}border-gray-700/50{% endif %} overflow-hidden"
                            data-index="{{ loop.index0 }}"
                            title="Screenshot {{ loop.index }}">
                            <img src="{{ shot }}" loading="lazy" referrerpolicy="no-referrer" class="w-full h-full object-cover" alt="Screenshot {{ loop.index }}" decoding="async">
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            </div>
            {% endif %}
            
            <!-- Emulation Guide Section - Now inside left column -->
            {% if emulator_guide %}
            <section>
                <h3 class="text-xl font-bold text-white mb-4 border-b border-gray-700/50 pb-2 flex items-center gap-2">
                    <span class="material-symbols-outlined text-blue-500">videogame_asset</span>
                    Emulation Guide for {{ emulator_guide.console_name }}
                </h3>
                
                {% if game.instruction and game.instruction_text %}
                <div class="mb-6 bg-red-900/30 p-4 rounded-lg border border-red-700/50">
                    <div class="flex items-start gap-3 mb-2">
                        <span class="material-symbols-outlined text-red-400 text-lg flex-shrink-0 mt-0.5">warning</span>
                        <div>
                            <div class="text-xs text-red-300 uppercase font-bold mb-2">This game has special instructions!</div>
                            <p class="text-xs text-red-100 leading-relaxed whitespace-pre-wrap">{{ game.instruction_text }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% if emulator_guide.guides %}
                <div class="space-y-3">
                    {% set platforms = ['windows', 'macos', 'linux', 'android', 'ios'] %}
                    {% set platform_names = {'windows': 'PC (Windows)', 'macos': 'macOS', 'linux': 'Linux', 'android': 'Android', 'ios': 'iOS'} %}
                    
                    {% for platform in platforms %}
                        {% set emulators = emulator_guide.guides.get(platform, []) %}
                        {% if emulators %}
                        <div class="border border-gray-700/50 rounded-lg overflow-hidden">
                            <button 
                                class="w-full px-6 py-4 bg-gray-900/50 hover:bg-gray-800/50 transition-all flex items-center justify-between group"
                                onclick="toggleEmulatorGuide('{{ platform }}')">
                                <div class="flex items-center gap-3">
                                    {% if platform == 'windows' %}
                                    <svg class="w-5 h-5 text-blue-400" fill="currentColor" viewBox="0 0 24 24"><path d="M3,12V6.75L9,5.43V11.91L3,12M20,3V11.75L10,11.9V5.21L20,3M3,13L9,13.09V19.9L3,18.75V13M20,13.25V22L10,20.09V13.1L20,13.25Z"/></svg>
                                    {% elif platform == 'macos' %}
                                    <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 24 24"><path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/></svg>
                                    {% elif platform == 'linux' %}
                                    <svg class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 24 24"><path d="M12.504 0c-.155 0-.315.008-.48.021-4.226.333-3.105 4.807-3.17 6.298-.076 1.092-.3 1.953-1.05 3.02-.885 1.051-2.127 2.75-2.716 4.521-.278.832-.41 1.684-.287 2.489a.424.424 0 00-.11.135c-.26.268-.45.6-.663.839-.199.199-.485.267-.797.4-.313.136-.658.269-.864.68-.09.189-.136.394-.132.602 0 .199.027.4.055.536.058.399.116.728.04.97-.249.68-.28 1.145-.106 1.484.174.334.535.47.94.601.81.2 1.91.135 2.774.6.926.466 1.866.67 2.616.47.526-.116.97-.464 1.208-.946.587-.003 1.23-.269 2.26-.334.699-.058 1.574.267 2.577.2.025.134.063.198.114.333l.003.003c.391.778 1.113 1.132 1.884 1.071.771-.06 1.592-.536 2.257-1.306.631-.765 1.683-1.084 2.378-1.503.348-.199.629-.469.649-.853.023-.4-.2-.811-.714-1.376v-.097l-.003-.003c-.17-.2-.25-.535-.338-.926-.085-.401-.182-.786-.492-1.046h-.003c-.059-.054-.123-.067-.188-.135a.357.357 0 00-.19-.064c.431-1.278.264-2.55-.173-3.694-.533-1.41-1.465-2.638-2.175-3.483-.796-1.005-1.576-1.957-1.56-3.368.026-2.152.236-6.133-3.544-6.139z"/></svg>
                                    {% elif platform == 'android' %}
                                    <svg class="w-5 h-5 text-green-400" fill="currentColor" viewBox="0 0 24 24"><path d="M17.6 9.48l1.84-3.18c.16-.31.04-.69-.26-.85-.29-.15-.68-.04-.84.27l-1.88 3.24c-2.86-1.21-6.08-1.21-8.94 0L5.65 5.67c-.16-.31-.55-.42-.84-.27-.3.16-.42.54-.26.85L7.4 9.48c-3.5 2.55-5.4 6.2-5.4 10.52h17.98c0-4.32-1.9-7.97-5.38-10.52zM8 17c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm8 0c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
                                    {% elif platform == 'ios' %}
                                    <svg class="w-5 h-5 text-gray-300" fill="currentColor" viewBox="0 0 24 24"><path d="M17 2H7c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-5 18c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm5.5-3H6V4h11v13z"/></svg>
                                    {% endif %}
                                    <span class="font-bold text-white">{{ platform_names.get(platform, platform|title) }}</span>
                                </div>
                                <span class="material-symbols-outlined text-gray-400 group-hover:text-white transition-all transform text-lg font-bold" id="icon-{{ platform }}">expand_more</span>
                            </button>
                            
                            <div id="guide-{{ platform }}" class="emulator-guide hidden max-h-0 overflow-hidden transition-all duration-300">
                                <div class="space-y-4 px-6 py-4 bg-blue-900/20 border-t border-blue-500/30">
                                    {% for emulator in emulators %}
                                    <div class="border border-blue-500/20 rounded-lg p-4 bg-gray-800/30">
                                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
                                            <div class="flex items-center gap-3">
                                                {% if emulator.logo_svg %}
                                                <div class="w-12 h-12 rounded bg-gray-700 flex items-center justify-center flex-shrink-0">
                                                    {{ emulator.logo_svg|safe }}
                                                </div>
                                                {% endif %}
                                                <div class="font-bold text-blue-300 text-lg">{{ emulator.name }}</div>
                                            </div>
                                            {% if emulator.link %}
                                            <a href="{{ emulator.link }}" target="_blank" rel="noopener noreferrer" class="flex items-center justify-center gap-2 px-4 py-2 rounded-lg bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 transition-all shadow-lg shadow-blue-500/25 hover:shadow-blue-400/40 hover:scale-105 transform duration-200 group w-full sm:w-auto">
                                                <span class="material-symbols-outlined text-sm text-white">language</span>
                                                <span class="text-sm font-semibold text-white">Emulator Website</span>
                                                <span class="material-symbols-outlined text-sm text-white group-hover:translate-x-1 transition-transform">arrow_outward</span>
                                            </a>
                                            {% endif %}
                                        </div>
                                        <div class="mb-3">
                                            <h5 class="text-xs font-bold text-blue-300 mb-1 flex items-center gap-1">
                                                <span class="material-symbols-outlined text-xs">download</span>
                                                Installation
                                            </h5>
                                            <p class="text-xs text-gray-300 leading-relaxed whitespace-pre-line ml-4">{{ emulator.installation }}</p>
                                        </div>
                                        <div>
                                            <h5 class="text-xs font-bold text-blue-300 mb-1 flex items-center gap-1">
                                                <span class="material-symbols-outlined text-xs">settings</span>
                                                Configuration
                                            </h5>
                                            <p class="text-xs text-gray-300 leading-relaxed whitespace-pre-line ml-4">{{ emulator.configuration }}</p>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
            </section>
            {% endif %}
        </div>
        <!-- END LEFT COLUMN -->

        <!-- RIGHT COLUMN: Info Sidebar -->
        <div class="lg:w-80 flex-shrink-0">
            <div class="bg-gray-900/50 border border-gray-700/50 p-6 rounded-xl shadow-lg">
                <div class="mb-6">
                    <div class="text-xs text-gray-500 uppercase font-bold mb-1">Base Game</div>
                    <div class="text-sm text-gray-300">{{ game.base_game }}</div>
                    {% if game.version_region %}
                    <div class="text-xs text-gray-500 mt-2">Base ROM version required: <span class="text-gray-300">{{ game.version_region }}</span></div>
                    {% endif %}
                </div>

                {% if game.instruction and game.instruction_text %}
                <div class="mb-6 bg-red-900/30 p-4 rounded-lg border border-red-700/50">
                    <div class="flex items-start gap-3">
                        <span class="material-symbols-outlined text-red-400 text-lg flex-shrink-0 mt-0.5">warning</span>
                        <div>
                            <div class="text-xs text-red-300 uppercase font-bold mb-2">Special Instructions!</div>
                            <p class="text-xs text-red-100 leading-relaxed whitespace-pre-wrap">{{ game.instruction_text }}</p>
                        </div>
                    </div>
                </div>
                {% endif %}

                <a href="{{ game.download_link }}" target="_blank" onclick="trackDownload('{{ game.id }}')" class="btn-retro w-full justify-center text-center py-4 mb-2">
                    {% if is_port %}
                        Download Port
                    {% else %}
                        Download Patch
                    {% endif %}
                </a>
                <p class="text-[10px] text-gray-500 text-center mb-4 italic">Redirects to official download page</p>
                
                {% if game.base_region or game.base_revision or game.base_header or game.base_checksum_crc32 or game.base_checksum_md5 or game.base_checksum_sha1 or game.patch_format or game.patch_output_ext %}
                <div class="mb-4 bg-black/30 p-4 rounded-lg border border-gray-700/50">
                    <div class="text-xs text-gray-500 uppercase font-bold mb-3">Base Game Requirements</div>
                    <div class="space-y-2 text-xs">
                        {% if game.base_region %}
                        <div><span class="text-gray-400">Region:</span> <span class="text-gray-200 font-mono">{{ game.base_region }}</span></div>
                        {% endif %}
                        {% if game.base_revision %}
                        <div><span class="text-gray-400">Revision:</span> <span class="text-gray-200 font-mono">{{ game.base_revision }}</span></div>
                        {% endif %}
                        {% if game.base_header %}
                        <div><span class="text-gray-400">Header:</span> <span class="text-gray-200 font-mono">{{ game.base_header }}</span></div>
                        {% endif %}
                        {% if game.base_checksum_crc32 %}
                        <div class="break-all"><span class="text-gray-400">CRC32:</span> <span class="text-gray-200 font-mono text-[10px]">{{ game.base_checksum_crc32 }}</span></div>
                        {% endif %}
                        {% if game.base_checksum_md5 %}
                        <div class="break-all"><span class="text-gray-400">MD5:</span> <span class="text-gray-200 font-mono text-[10px]">{{ game.base_checksum_md5 }}</span></div>
                        {% endif %}
                        {% if game.base_checksum_sha1 %}
                        <div class="break-all"><span class="text-gray-400">SHA-1:</span> <span class="text-gray-200 font-mono text-[10px]">{{ game.base_checksum_sha1 }}</span></div>
                        {% endif %}
                        {% if game.patch_format %}
                        <div><span class="text-gray-400">Patch Format:</span> <span class="text-gray-200 font-mono">{{ game.patch_format }}</span></div>
                        {% endif %}
                        {% if game.patch_output_ext %}
                        <div><span class="text-gray-400">Output Extension:</span> <span class="text-gray-200 font-mono">{{ game.patch_output_ext }}</span></div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                {% if game.official_website %}
                <a href="{{ game.official_website }}" target="_blank" rel="noopener noreferrer" class="flex items-center justify-center gap-2 w-full bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white font-bold py-3 px-3 rounded-lg transition-all shadow-lg shadow-blue-500/30 hover:shadow-blue-400/40 mb-4">
                    <span class="material-symbols-outlined text-base sm:text-lg">language</span>
                    <span class="text-sm sm:text-base">Official Website</span>
                    <span class="material-symbols-outlined text-xs sm:text-sm">open_in_new</span>
                </a>
                {% endif %}
                
                <div class="flex items-center justify-between px-2 py-2 mb-4">
                    {% if not is_port %}
                    <a href="/patcher#faq" class="text-blue-400 text-xs hover:text-white transition-all font-semibold">What's a patch?</a>
                    {% endif %}
                    <span class="inline-flex items-center gap-2 text-[12px] font-mono text-gray-300">
                        <span class="material-symbols-outlined text-[14px] text-blue-400">download</span>
                        <span id="download-count">{{ download_count | default(0) | download_count_label }}</span> downloads
                    </span>
                </div>

                {% if game.features %}
                <div class="border-t border-gray-800 pt-4 mt-4">
                    <div class="text-xs text-gray-500 uppercase font-bold mb-3">Key Features</div>
                    <ul class="space-y-2">
                        {% if game.online_play %}
                        <li class="flex items-center gap-2 text-xs text-green-300">
                            <span class="material-symbols-outlined text-green-400 text-sm">lan</span> 
                            Online Play
                        </li>
                        {% endif %}
                        {% for feature in game.features %}
                        <li class="flex items-center gap-2 text-xs text-gray-300">
                            <span class="material-symbols-outlined text-blue-500 text-sm">check_circle</span> 
                            {{ feature }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% elif game.online_play %}
                <div class="border-t border-gray-800 pt-4 mt-4">
                    <div class="text-xs text-gray-500 uppercase font-bold mb-3">Features</div>
                    <ul class="space-y-2">
                        <li class="flex items-center gap-2 text-xs text-green-300">
                            <span class="material-symbols-outlined text-green-400 text-sm">lan</span> 
                            Online Play
                        </li>
                    </ul>
                </div>
                {% endif %}
                
                <!-- Common Issues Tab -->
                {% if game.support_forum_url or game.discord_url or game.reddit_url or game.troubleshooting_url or game.rom_checker_url or game.wiki_url or social_links %}
                <div class="border border-gray-700/50 rounded-lg p-4 bg-gray-900/30 mt-4">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="material-symbols-outlined text-yellow-500 text-lg">help</span>
                        <h4 class="text-sm font-bold text-white">Need Help?</h4>
                    </div>
                    <div class="space-y-2 text-xs text-gray-400">
                        <p class="mb-2">Experiencing problems? Check out these resources:</p>
                        <div class="flex flex-col gap-2">
                            {% if game.troubleshooting_url %}
                            <a href="{{ game.troubleshooting_url }}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-blue-400 hover:text-blue-300 transition-all">
                                <span class="material-symbols-outlined text-sm">menu_book</span>
                                <span>Troubleshooting Guide / FAQ</span>
                            </a>
                            {% endif %}
                            {% if game.wiki_url %}
                            <a href="{{ game.wiki_url }}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-blue-400 hover:text-blue-300 transition-all">
                                <span class="material-symbols-outlined text-sm">menu_book</span>
                                <span>Wiki</span>
                            </a>
                            {% endif %}
                            {% if game.rom_checker_url %}
                            <a href="{{ game.rom_checker_url }}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-blue-400 hover:text-blue-300 transition-all">
                                <span class="material-symbols-outlined text-sm">verified</span>
                                <span>ROM Compatibility Checker</span>
                            </a>
                            {% endif %}
                            {% if game.support_forum_url %}
                            <a href="{{ game.support_forum_url }}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-blue-400 hover:text-blue-300 transition-all">
                                <span class="material-symbols-outlined text-sm">forum</span>
                                <span>Support Forum</span>
                            </a>
                            {% endif %}
                            {% if game.discord_url %}
                            <a href="{{ game.discord_url }}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-blue-400 hover:text-blue-300 transition-all">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M20.317 4.369a19.791 19.791 0 00-4.885-1.515.074.074 0 00-.079.037c-.211.375-.445.864-.607 1.25a18.27 18.27 0 00-5.487 0c-.162-.386-.395-.875-.607-1.25a.077.077 0 00-.079-.037A19.736 19.736 0 003.677 4.37a.07.07 0 00-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 00.031.057 19.9 19.9 0 005.993 3.03.08.08 0 00.087-.027c.461-.63.873-1.295 1.226-1.994a.076.076 0 00-.042-.106 13.107 13.107 0 01-1.872-.892.077.077 0 00-.008-.128 10.72 10.72 0 00.372-.294.075.075 0 00.076-.01c3.928 1.793 8.18 1.793 12.062 0a.075.075 0 00.076.009c.12.098.246.198.373.294a.077.077 0 00-.006.127 12.299 12.299 0 01-1.873.892.076.076 0 00-.041.107c.36.699.772 1.365 1.225 1.994a.08.08 0 00.087.028 19.86 19.86 0 006.002-3.03.077.077 0 00.032-.056c.5-5.094-.838-9.52-3.549-13.442a.06.06 0 00-.031-.028zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
                                <span>Discord Server</span>
                            </a>
                            {% endif %}
                            {% if game.reddit_url %}
                            <a href="{{ game.reddit_url }}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-blue-400 hover:text-blue-300 transition-all">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/></svg>
                                <span>Reddit Community</span>
                            </a>
                            {% endif %}
                            {% for link in social_links %}
                            {% if link.type == 'github' %}
                            <a href="{{ link.url }}/issues" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 text-blue-400 hover:text-blue-300 transition-all">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                                <span>Report Issues on GitHub</span>
                            </a>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <div class="border-t border-gray-800 pt-4 mt-4">
                    <p class="text-[10px] text-gray-500 mb-2">Have the base file?</p>
                    <a href="/patcher" class="block text-center text-blue-400 text-xs hover:text-white border border-blue-500/30 hover:border-blue-500 py-2 rounded-lg transition-all">
                        Go to Web Patcher
                    </a>
                </div>
            </div>
        </div>
        <!-- END RIGHT COLUMN -->
    </div>
    <!-- END Screenshots and Info Section -->

    <!-- ============================================ -->
    <!-- REVIEWS SECTION - Steam-style with RA Login -->
    <!-- ============================================ -->
    <section class="mt-12 w-full max-w-6xl mx-auto px-4" id="reviews-section">
        <div class="flex flex-col md:flex-row gap-6 w-full">
            <!-- Left: Reviews Feed -->
            <div class="flex-1 min-w-0 w-full">
                <!-- Header -->
                <div class="flex items-center gap-3 mb-6">
                    <span class="material-symbols-outlined text-3xl text-blue-400">reviews</span>
                    <h2 class="text-2xl font-bold text-white pixel-font">Reviews</h2>
                </div>

                <!-- Login CTA (shown when not logged in) -->
                <div id="login-cta" class="hidden bg-gradient-to-r from-[#16202d] to-[#1b2838] p-6 rounded-xl border border-[#2a475e] shadow-lg mb-6">
                    <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                        <div>
                            <h3 class="text-lg text-white font-bold mb-1">Played {{ game.title }}?</h3>
                            <p class="text-sm text-gray-400">Log in with RetroAchievements to share your experience!</p>
                        </div>
                        <button onclick="openRALogin()" class="ra-login-btn text-white px-6 py-3 rounded-lg font-bold shadow-lg flex items-center gap-2 whitespace-nowrap">
                            <span class="material-symbols-outlined text-yellow-300">emoji_events</span>
                            Login with RA
                        </button>
                    </div>
                </div>

                <!-- Review Form (shown when logged in) -->
                <div id="review-form-container" class="hidden bg-[#16202d] p-6 rounded-xl border border-gray-700/50 mb-6">
                    <div class="flex items-center gap-3 mb-4">
                        <img id="user-avatar" src="" alt="" class="w-12 h-12 rounded-lg border border-gray-600">
                        <div>
                            <div id="user-name" class="text-white font-bold"></div>
                            <div class="text-xs text-gray-500 flex items-center gap-1">
                                <span class="material-symbols-outlined text-xs text-yellow-500">emoji_events</span>
                                <span id="user-points">0</span> points
                            </div>
                        </div>
                        <button onclick="logoutRA()" class="ml-auto text-xs text-gray-500 hover:text-red-400 transition">Logout</button>
                    </div>

                    <form id="review-form" onsubmit="submitReview(event)">
                        <!-- Thumbs Up/Down Selection -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-300 mb-3">Do you recommend this ROM hack?</label>
                            <div class="flex gap-3">
                                <button type="button" onclick="selectRecommendation(true)" id="btn-recommend" 
                                    class="flex-1 py-4 px-6 rounded-lg border-2 border-gray-600 bg-gray-800/50 hover:border-blue-500 transition flex items-center justify-center gap-3 group recommendation-btn">
                                    <span class="material-symbols-outlined text-3xl text-gray-400 group-hover:text-blue-400 transition">thumb_up</span>
                                    <span class="text-gray-300 font-medium">Yes</span>
                                </button>
                                <button type="button" onclick="selectRecommendation(false)" id="btn-not-recommend"
                                    class="flex-1 py-4 px-6 rounded-lg border-2 border-gray-600 bg-gray-800/50 hover:border-red-500 transition flex items-center justify-center gap-3 group recommendation-btn">
                                    <span class="material-symbols-outlined text-3xl text-gray-400 group-hover:text-red-400 transition">thumb_down</span>
                                    <span class="text-gray-300 font-medium">No</span>
                                </button>
                            </div>
                            <input type="hidden" name="recommended" id="recommended-input" value="">
                        </div>

                        <!-- Review Text -->
                        <div class="mb-4">
                            <label for="review-text" class="block text-sm font-medium text-gray-300 mb-2">Your Review (optional)</label>
                            <textarea id="review-text" name="review_text" rows="4" 
                                class="w-full bg-[#0f0f12] border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500 transition resize-none"
                                placeholder="Write your thoughts about this ROM hack..."></textarea>
                        </div>

                        <button type="submit" id="submit-review-btn"
                            class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-lg font-bold transition flex items-center justify-center gap-2">
                            <span class="material-symbols-outlined">send</span>
                            Post Review
                        </button>
                    </form>
                </div>

                <!-- Filter Bar -->
                <div class="bg-[#101822] p-4 rounded-lg flex flex-col sm:flex-row justify-between items-center border border-gray-800 gap-4 mb-4">
                    <div class="flex items-center gap-2 flex-wrap">
                        <button onclick="filterReviews('all')" class="review-filter-btn active" data-filter="all">All</button>
                        <button onclick="filterReviews('positive')" class="review-filter-btn" data-filter="positive">
                            <span class="material-symbols-outlined text-sm text-blue-400">thumb_up</span> Positive
                        </button>
                        <button onclick="filterReviews('negative')" class="review-filter-btn" data-filter="negative">
                            <span class="material-symbols-outlined text-sm text-red-400">thumb_down</span> Negative
                        </button>
                    </div>
                    <select id="sort-select" onchange="sortReviews(this.value)" class="bg-[#1b2838] text-sm text-blue-400 border border-gray-700 rounded px-3 py-2 outline-none focus:border-blue-500">
                        <option value="helpful">Most Helpful</option>
                        <option value="recent">Most Recent</option>
                    </select>
                </div>

                <!-- Reviews List -->
                <div id="reviews-list" class="space-y-4 min-h-[300px] overflow-hidden break-words w-full">
                    <div class="text-center py-8 text-gray-500">
                        <span class="material-symbols-outlined text-4xl mb-2 block">hourglass_empty</span>
                        Loading reviews...
                    </div>
                </div>

                <!-- Load More -->
                <button id="load-more-btn" onclick="loadMoreReviews()" class="hidden w-full py-3 bg-gray-800 hover:bg-gray-700 text-white text-sm font-bold rounded-lg transition mt-4">
                    Load More Reviews
                </button>
            </div>

            <!-- Right: Stats Sidebar -->
            <aside class="w-full md:w-72 flex-shrink-0">
                <div class="bg-[#121921] p-6 rounded-xl border border-gray-800 sticky top-24">
                    <h3 class="text-sm text-blue-400 font-bold uppercase mb-4">Overall Rating</h3>
                    
                    <div id="rating-summary" class="text-center py-6">
                        <div class="text-5xl font-bold text-gray-500 mb-2">—</div>
                        <div class="text-gray-500 text-sm">No reviews yet</div>
                    </div>
                </div>
            </aside>
        </div>
    </section>

    <!-- Claim It Section -->
    <div class="mt-16 mb-12 bg-[#1a1a20] border border-gray-800/50 rounded-xl p-8 text-center max-w-6xl mx-auto">
        <h3 class="text-xl font-bold pixel-font text-white mb-2">Is this your project?</h3>
        <p class="text-gray-400 text-sm mb-4">Help us keep the database accurate and complete.</p>
        <div class="flex flex-col sm:flex-row gap-3 justify-center">
            <a href="{{ url_for('claim', game_id=game.id, title=game.title) }}" class="inline-flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-semibold transition-all">
                <span class="material-symbols-outlined text-base">verified_user</span>
                Claim it!
            </a>
            <a href="{{ url_for('contact', type='correction', title=game.title) }}" class="inline-flex items-center justify-center gap-2 bg-gray-700 hover:bg-gray-600 text-white px-6 py-2 rounded-lg text-sm font-semibold transition-all">
                <span class="material-symbols-outlined text-base">flag</span>
                Report Issue
            </a>
        </div>
    </div>

</div>

<!-- Screenshot Modal Lightbox -->
<div id="screenshot-modal" class="fixed inset-0 bg-black/90 hidden z-50 flex items-center justify-center p-4" onclick="if(event.target.id === 'screenshot-modal') closeScreenshotModal()">
    <button onclick="closeScreenshotModal()" class="absolute top-4 right-4 text-white/70 hover:text-white transition-all z-50">
        <span class="material-symbols-outlined text-4xl">close</span>
    </button>
    
    <div class="relative w-full h-full flex items-center justify-center" onclick="event.stopPropagation()">
        <img id="modal-screenshot" referrerpolicy="no-referrer" src="" class="max-w-full max-h-full object-contain" alt="Enlarged screenshot">
        
        <!-- Modal Navigation -->
        <button onclick="modalPrevScreenshot()" class="absolute left-4 top-1/2 -translate-y-1/2 text-white/50 hover:text-white transition-all p-3" id="modal-prev-arrow">
            <span class="material-symbols-outlined text-5xl">chevron_left</span>
        </button>
        <button onclick="modalNextScreenshot()" class="absolute right-4 top-1/2 -translate-y-1/2 text-white/50 hover:text-white transition-all p-3" id="modal-next-arrow">
            <span class="material-symbols-outlined text-5xl">chevron_right</span>
        </button>
        
        <!-- Screenshot Counter -->
        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-black/50 px-4 py-2 rounded-lg text-white/70 text-sm font-mono">
            <span id="modal-counter">1</span> / <span id="modal-total">1</span>
        </div>
    </div>
</div>

<!-- Screenshot data for JavaScript -->
<script id="screenshot-data" type="application/json">{{ game.screenshots | tojson }}</script>

<!-- Screenshot Navigation Scripts -->
<script>
const screenshotData = document.getElementById('screenshot-data');
const allScreenshots = screenshotData ? JSON.parse(screenshotData.textContent) : [];

let currentScreenshotIndex = 0;
const thumbnailWidth = 88; // width (80px) + gap (8px)

function selectScreenshot(index) {
    // Clamp index to valid range
    index = Math.max(0, Math.min(index, allScreenshots.length - 1));
    currentScreenshotIndex = index;
    
    const mainImg = document.getElementById('main-screenshot');
    if (mainImg) {
        mainImg.src = allScreenshots[index];
    }
    
    // Update thumbnail borders
    document.querySelectorAll('#thumbnail-container button').forEach((btn, i) => {
        btn.classList.toggle('border-blue-400', i === index);
        btn.classList.toggle('border-gray-700/50', i !== index);
    });
    
    // Auto-scroll to show selected thumbnail
    ensureThumbbnailVisible(index);
    updateArrowState();
}

function scrollThumbnails(direction) {
    const container = document.getElementById('thumbnail-container');
    if (!container) return;
    const scrollAmount = thumbnailWidth * 3; // Scroll by 3 thumbnails
    container.scrollBy({ left: direction * scrollAmount, behavior: 'smooth' });
}

function ensureThumbbnailVisible(index) {
    const container = document.getElementById('thumbnail-container');
    if (!container) return;
    const button = container.querySelector(`button:nth-child(${index + 1})`);
    if (button) {
        button.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    }
}

function updateArrowState() {
    const prevArrow = document.getElementById('prev-arrow');
    const nextArrow = document.getElementById('next-arrow');
    
    if (prevArrow) {
        prevArrow.style.opacity = currentScreenshotIndex === 0 ? '0' : '1';
        prevArrow.style.pointerEvents = currentScreenshotIndex === 0 ? 'none' : 'auto';
    }
    
    if (nextArrow) {
        nextArrow.style.opacity = currentScreenshotIndex >= allScreenshots.length - 1 ? '0' : '1';
        nextArrow.style.pointerEvents = currentScreenshotIndex >= allScreenshots.length - 1 ? 'none' : 'auto';
    }
}

// Keyboard navigation
document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft' && currentScreenshotIndex > 0) {
        selectScreenshot(currentScreenshotIndex - 1);
    } else if (e.key === 'ArrowRight' && currentScreenshotIndex < allScreenshots.length - 1) {
        selectScreenshot(currentScreenshotIndex + 1);
    }
});

// Add click listeners to thumbnails
document.addEventListener('DOMContentLoaded', () => {
    const thumbnails = document.querySelectorAll('.screenshot-thumbnail');
    thumbnails.forEach(thumbnail => {
        thumbnail.addEventListener('click', () => {
            const index = parseInt(thumbnail.getAttribute('data-index'), 10);
            selectScreenshot(index);
        });
    });
    
    // Add click listeners to navigation arrows
    const prevArrow = document.querySelector('.nav-arrow-prev');
    const nextArrow = document.querySelector('.nav-arrow-next');
    
    if (prevArrow) {
        prevArrow.addEventListener('click', (e) => {
            e.stopPropagation();
            selectScreenshot(currentScreenshotIndex - 1);
        });
    }
    
    if (nextArrow) {
        nextArrow.addEventListener('click', (e) => {
            e.stopPropagation();
            selectScreenshot(currentScreenshotIndex + 1);
        });
    }
    
    // Add click listener to main screenshot container
    const mainContainer = document.getElementById('main-screenshot-container');
    if (mainContainer) {
        mainContainer.addEventListener('click', () => {
            openScreenshotModal(currentScreenshotIndex);
        });
    }
});

// Update arrow states on load and resize
window.addEventListener('load', updateArrowState);
window.addEventListener('resize', updateArrowState);

// Swipe gesture for screenshot navigation
let touchStartX = 0;
let touchEndX = 0;

function handleSwipe(container) {
    if (touchStartX - touchEndX > 50) {
        // Swiped left - go to next screenshot
        if (currentScreenshotIndex < allScreenshots.length - 1) {
            selectScreenshot(currentScreenshotIndex + 1);
        }
    } else if (touchEndX - touchStartX > 50) {
        // Swiped right - go to previous screenshot
        if (currentScreenshotIndex > 0) {
            selectScreenshot(currentScreenshotIndex - 1);
        }
    }
}

document.addEventListener('touchstart', (e) => {
    const screenshotContainer = document.getElementById('main-screenshot');
    if (!screenshotContainer) return;
    const mainContainer = screenshotContainer.closest('.relative');
    if (mainContainer && mainContainer.contains(e.target)) {
        touchStartX = e.changedTouches[0].screenX;
    }
}, false);

document.addEventListener('touchend', (e) => {
    const screenshotContainer = document.getElementById('main-screenshot');
    if (!screenshotContainer) return;
    const mainContainer = screenshotContainer.closest('.relative');
    if (mainContainer && mainContainer.contains(e.target)) {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe(mainContainer);
    }
}, false);

// Screenshot Modal Functions
function openScreenshotModal(index) {
    const modal = document.getElementById('screenshot-modal');
    const modalImg = document.getElementById('modal-screenshot');
    const counter = document.getElementById('modal-counter');
    const total = document.getElementById('modal-total');
    
    if (modal && modalImg && allScreenshots.length > 0) {
        currentScreenshotIndex = Math.max(0, Math.min(index, allScreenshots.length - 1));
        modalImg.src = allScreenshots[currentScreenshotIndex];
        counter.textContent = currentScreenshotIndex + 1;
        total.textContent = allScreenshots.length;
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        updateModalArrowState();
    }
}

function closeScreenshotModal(event) {
    const modal = document.getElementById('screenshot-modal');
    if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
    }
}

function modalNextScreenshot() {
    if (currentScreenshotIndex < allScreenshots.length - 1) {
        currentScreenshotIndex++;
        updateModalImage();
    }
}

function modalPrevScreenshot() {
    if (currentScreenshotIndex > 0) {
        currentScreenshotIndex--;
        updateModalImage();
    }
}

function updateModalImage() {
    const modalImg = document.getElementById('modal-screenshot');
    const counter = document.getElementById('modal-counter');
    
    if (modalImg && allScreenshots.length > 0) {
        modalImg.src = allScreenshots[currentScreenshotIndex];
        counter.textContent = currentScreenshotIndex + 1;
        updateModalArrowState();
    }
}

function updateModalArrowState() {
    const prevArrow = document.getElementById('modal-prev-arrow');
    const nextArrow = document.getElementById('modal-next-arrow');
    
    if (prevArrow) {
        prevArrow.style.opacity = currentScreenshotIndex === 0 ? '0.2' : '1';
        prevArrow.style.pointerEvents = currentScreenshotIndex === 0 ? 'none' : 'auto';
    }
    
    if (nextArrow) {
        nextArrow.style.opacity = currentScreenshotIndex >= allScreenshots.length - 1 ? '0.2' : '1';
        nextArrow.style.pointerEvents = currentScreenshotIndex >= allScreenshots.length - 1 ? 'none' : 'auto';
    }
}

// Modal keyboard shortcuts
document.addEventListener('keydown', (e) => {
    const modal = document.getElementById('screenshot-modal');
    if (modal && !modal.classList.contains('hidden')) {
        if (e.key === 'ArrowLeft') {
            modalPrevScreenshot();
        } else if (e.key === 'ArrowRight') {
            modalNextScreenshot();
        } else if (e.key === 'Escape') {
            closeScreenshotModal();
        }
    }
});

// Modal swipe gestures
let modalTouchStartX = 0;
let modalTouchEndX = 0;

function handleModalSwipe() {
    if (modalTouchStartX - modalTouchEndX > 50) {
        // Swiped left - go to next screenshot
        modalNextScreenshot();
    } else if (modalTouchEndX - modalTouchStartX > 50) {
        // Swiped right - go to previous screenshot
        modalPrevScreenshot();
    }
}

document.addEventListener('touchstart', (e) => {
    const modal = document.getElementById('screenshot-modal');
    if (modal && !modal.classList.contains('hidden')) {
        modalTouchStartX = e.changedTouches[0].screenX;
    }
}, false);

document.addEventListener('touchend', (e) => {
    const modal = document.getElementById('screenshot-modal');
    if (modal && !modal.classList.contains('hidden')) {
        modalTouchEndX = e.changedTouches[0].screenX;
        handleModalSwipe();
    }
}, false);

// Instructions Accordion
function toggleInstructions(platform) {
    const content = document.getElementById(`content-${platform}`);
    const icon = document.getElementById(`icon-${platform}`);
    
    if (!content) return;
    
    const isHidden = content.classList.contains('hidden');
    
    // Close all other instructions
    document.querySelectorAll('.instructions-content').forEach(el => {
        if (el.id !== `content-${platform}`) {
            el.classList.add('hidden');
            el.style.maxHeight = '0';
        }
    });
    
    // Update all icons
    document.querySelectorAll('[id^="icon-"]').forEach(el => {
        if (el.id !== `icon-${platform}`) {
            el.textContent = 'expand_more';
        }
    });
    
    // Toggle current
    if (isHidden) {
        content.classList.remove('hidden');
        setTimeout(() => {
            content.style.maxHeight = content.scrollHeight + 'px';
        }, 10);
        icon.textContent = 'expand_less';
    } else {
        content.style.maxHeight = '0';
        setTimeout(() => {
            content.classList.add('hidden');
        }, 300);
        icon.textContent = 'expand_more';
    }
}

// Emulator Guide Accordion
function toggleEmulatorGuide(platform) {
    const content = document.getElementById(`guide-${platform}`);
    const icon = document.getElementById(`icon-${platform}`);
    
    if (!content) return;
    
    const isHidden = content.classList.contains('hidden');
    
    // Close all other guides
    document.querySelectorAll('.emulator-guide').forEach(el => {
        if (el.id !== `guide-${platform}`) {
            el.classList.add('hidden');
            el.style.maxHeight = '0';
        }
    });
    
    // Update all icons for emulator guides only
    document.querySelectorAll('.emulator-guide').forEach(el => {
        const guidePlatform = el.id.replace('guide-', '');
        const otherIcon = document.getElementById(`icon-${guidePlatform}`);
        if (otherIcon && guidePlatform !== platform) {
            otherIcon.textContent = 'expand_more';
        }
    });
    
    // Toggle current
    if (isHidden) {
        content.classList.remove('hidden');
        setTimeout(() => {
            content.style.maxHeight = content.scrollHeight + 'px';
        }, 10);
        if (icon) icon.textContent = 'expand_less';
    } else {
        content.style.maxHeight = '0';
        setTimeout(() => {
            content.classList.add('hidden');
        }, 300);
        if (icon) icon.textContent = 'expand_more';
    }
}

// ============================================
// REVIEW SYSTEM
// ============================================
const GAME_ID = '{{ game.id }}';
const GAME_TYPE = 'romhack';
let currentUser = null;
let currentFilter = 'all';
let currentSort = 'helpful';
let reviewsOffset = 0;
const REVIEWS_LIMIT = 20;
let selectedRecommendation = null;

// Initialize review system
document.addEventListener('DOMContentLoaded', () => {
    checkAuthStatus();
    loadReviews();
});

// Check if user is logged in
async function checkAuthStatus() {
    try {
        const res = await fetch('/api/auth/status');
        const data = await res.json();
        
        if (data.logged_in) {
            currentUser = data.user;
            showLoggedInUI();
        } else {
            showLoginCTA();
        }
    } catch (err) {
        showLoginCTA();
    }
}

function showLoginCTA() {
    document.getElementById('login-cta').classList.remove('hidden');
    document.getElementById('review-form-container').classList.add('hidden');
}

function showLoggedInUI() {
    document.getElementById('login-cta').classList.add('hidden');
    document.getElementById('review-form-container').classList.remove('hidden');
    
    // Set user info
    document.getElementById('user-avatar').src = currentUser.profile_pic;
    document.getElementById('user-avatar').alt = currentUser.username;
    document.getElementById('user-name').textContent = currentUser.username;
    document.getElementById('user-points').textContent = currentUser.total_points.toLocaleString();
    
    // Reset button text (will be updated by loadReviews if user has reviewed)
    const submitBtn = document.getElementById('submit-review-btn');
    submitBtn.innerHTML = '<span class="material-symbols-outlined">send</span> Post Review';
}

function openRALogin() {
    window.location.href = `/auth/ra/login-page?return_url=${encodeURIComponent(window.location.pathname + '#reviews-section')}`;
}

async function logoutRA() {
    try {
        await fetch('/auth/ra/logout', { method: 'POST' });
        currentUser = null;
        showLoginCTA();
        loadReviews(); // Reload to clear user votes
    } catch (err) {
        console.error('Logout failed:', err);
    }
}

// Select recommendation (thumbs up/down)
function selectRecommendation(recommended) {
    selectedRecommendation = recommended;
    
    const yesBtn = document.getElementById('btn-recommend');
    const noBtn = document.getElementById('btn-not-recommend');
    
    // Reset both
    yesBtn.classList.remove('border-blue-500', 'bg-blue-500/20');
    noBtn.classList.remove('border-red-500', 'bg-red-500/20');
    yesBtn.querySelector('.material-symbols-outlined').classList.remove('text-blue-400');
    noBtn.querySelector('.material-symbols-outlined').classList.remove('text-red-400');
    yesBtn.querySelector('.material-symbols-outlined').classList.add('text-gray-400');
    noBtn.querySelector('.material-symbols-outlined').classList.add('text-gray-400');
    
    if (recommended === true) {
        yesBtn.classList.add('border-blue-500', 'bg-blue-500/20');
        yesBtn.querySelector('.material-symbols-outlined').classList.remove('text-gray-400');
        yesBtn.querySelector('.material-symbols-outlined').classList.add('text-blue-400');
    } else if (recommended === false) {
        noBtn.classList.add('border-red-500', 'bg-red-500/20');
        noBtn.querySelector('.material-symbols-outlined').classList.remove('text-gray-400');
        noBtn.querySelector('.material-symbols-outlined').classList.add('text-red-400');
    }
    // If recommended is null, both stay reset (gray)
    
    document.getElementById('recommended-input').value = recommended === true ? '1' : (recommended === false ? '0' : '');
}

// Submit review
async function submitReview(e) {
    e.preventDefault();
    
    if (selectedRecommendation === null) {
        alert('Please select whether you recommend this ROM hack or not.');
        return;
    }
    
    const btn = document.getElementById('submit-review-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="material-symbols-outlined animate-spin">refresh</span> Submitting...';
    
    try {
        const res = await fetch(`/api/reviews/${GAME_ID}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                type: GAME_TYPE,
                recommended: selectedRecommendation,
                review_text: document.getElementById('review-text').value.trim()
            })
        });
        
        // Handle rate limiting (429)
        if (res.status === 429) {
            alert('Too many requests. Please wait a few minutes before submitting another review.');
            return;
        }
        
        // Check if response is JSON
        const contentType = res.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            console.error('Non-JSON response:', res.status);
            alert('Server error. Please try again later.');
            return;
        }
        
        const data = await res.json();
        
        if (data.success) {
            // Show success message
            const reviewText = document.getElementById('review-text').value.trim();
            const confirmMsg = reviewText 
                ? '✓ Review posted successfully!' 
                : '✓ Rating submitted! (Add text to display in reviews)';
            
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2 animate-fade-in';
            toast.innerHTML = `
                <span class="material-symbols-outlined">check_circle</span>
                <span>${confirmMsg}</span>
            `;
            document.body.appendChild(toast);
            
            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
            
            // Reset form
            document.getElementById('review-text').value = '';
            selectedRecommendation = null;
            selectRecommendation(null);
            
            // Reload reviews without showing loader to prevent flicker
            reviewsOffset = 0;
            loadReviews(false, false);
        } else {
            console.error('Submit error:', data.error);
            alert(data.error || 'Failed to submit review');
        }
    } catch (err) {
        console.error('Connection error:', err);
        alert('Failed to submit review. Please try again.');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span class="material-symbols-outlined">send</span> Post Review';
    }
}

// Load reviews
async function loadReviews(append = false, showLoader = true) {
    if (!append) {
        reviewsOffset = 0;
        if (showLoader) {
            document.getElementById('reviews-list').innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <span class="material-symbols-outlined text-4xl mb-2 block animate-spin">refresh</span>
                    Loading reviews...
                </div>
            `;
        }
    }
    
    try {
        const res = await fetch(`/api/reviews/${GAME_ID}?type=${GAME_TYPE}&sort=${currentSort}&filter=${currentFilter}&limit=${REVIEWS_LIMIT}&offset=${reviewsOffset}`);
        
        // Check if response is JSON
        const contentType = res.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            console.error('Non-JSON response:', res.status, await res.text());
            throw new Error('Server returned non-JSON response');
        }
        
        const data = await res.json();
        console.log('Reviews API response:', data);
        
        if (data.error) {
            console.error('API Error:', data.error);
        }
        
        renderReviewStats(data.stats || {total: 0, positive: 0, negative: 0, percentage: 0, label: 'No Reviews', label_class: 'neutral'});
        renderReviews(data.reviews || [], data.user_votes || {}, data.user_review, append);
        
        // Show/hide load more button
        const loadMoreBtn = document.getElementById('load-more-btn');
        if (data.reviews.length >= REVIEWS_LIMIT) {
            loadMoreBtn.classList.remove('hidden');
        } else {
            loadMoreBtn.classList.add('hidden');
        }
        
        // If user has already reviewed, populate form
        if (data.user_review && currentUser) {
            document.getElementById('review-text').value = data.user_review.review_text || '';
            selectRecommendation(data.user_review.recommended === 1);
            
            // Update button text to show it's an update
            const submitBtn = document.getElementById('submit-review-btn');
            submitBtn.innerHTML = '<span class="material-symbols-outlined">edit</span> Update Review';
        } else if (currentUser) {
            // Reset button text if no review exists
            const submitBtn = document.getElementById('submit-review-btn');
            submitBtn.innerHTML = '<span class="material-symbols-outlined">send</span> Post Review';
        }
    } catch (err) {
        console.error('Failed to load reviews:', err);
        document.getElementById('reviews-list').innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <span class="material-symbols-outlined text-4xl mb-2 block">error</span>
                Failed to load reviews
            </div>
        `;
    }
}

function renderReviewStats(stats) {
    const summaryEl = document.getElementById('rating-summary');
    
    if (stats.total === 0) {
        summaryEl.innerHTML = `
            <div class="text-5xl font-bold text-gray-500 mb-2">—</div>
            <div class="text-gray-500 text-sm">No reviews yet</div>
            <div class="text-gray-600 text-xs mt-1">Be the first to review!</div>
        `;
    } else {
        const labelClass = stats.label_class === 'very-positive' ? 'text-blue-400' :
                          stats.label_class === 'positive' ? 'text-blue-300' :
                          stats.label_class === 'mixed' ? 'text-yellow-400' :
                          stats.label_class === 'negative' ? 'text-orange-400' :
                          stats.label_class === 'very-negative' ? 'text-red-400' : 'text-gray-400';
        
        const reviewCount = stats.total.toLocaleString();
        
        summaryEl.innerHTML = `
            <div class="text-4xl font-bold ${labelClass} mb-1">${stats.percentage}%</div>
            <div class="${labelClass} font-bold text-lg mb-2">${stats.label}</div>
            <div class="text-gray-500 text-sm">(${reviewCount} review${stats.total !== 1 ? 's' : ''})</div>
        `;
    }
}

function renderReviews(reviews, userVotes, userReview, append) {
    const container = document.getElementById('reviews-list');
    
    if (!append) {
        container.innerHTML = '';
    }
    
    if (reviews.length === 0 && !append) {
        // Determine message based on filter
        let message = 'No written reviews yet';
        let subMessage = 'Be the first to write a review!';
        
        if (currentFilter === 'positive') {
            message = 'No positive reviews yet';
            subMessage = 'Be the first to recommend this!';
        } else if (currentFilter === 'negative') {
            message = 'No negative reviews yet';
            subMessage = 'All reviews are positive so far!';
        }
        
        container.innerHTML = `
            <div class="text-center py-12 text-gray-500 w-full">
                <span class="material-symbols-outlined text-5xl mb-3 block">rate_review</span>
                <div class="text-lg mb-1">${message}</div>
                <div class="text-sm">${subMessage}</div>
            </div>
        `;
        return;
    }
    
    reviews.forEach(review => {
        const isRecommended = review.recommended === 1;
        const thumbIcon = isRecommended ? 'thumb_up' : 'thumb_down';
        const thumbColor = isRecommended ? 'text-blue-400' : 'text-red-400';
        const recText = isRecommended ? 'Recommended' : 'Not Recommended';
        const userVote = userVotes[review.id];
        
        // Build progress display
        let progressHtml = '';
        if (review.achievements_total > 0) {
            progressHtml = `
                <div class="bg-[#0f1419] px-3 py-2 rounded mt-2 text-xs flex items-center gap-3 border border-gray-800">
                    <span class="material-symbols-outlined text-yellow-500 text-base">military_tech</span>
                    <div class="flex-1">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-gray-400">Progress</span>
                            <span class="text-yellow-400 font-bold">${review.completion_percentage}%</span>
                        </div>
                        <div class="w-full bg-gray-800 rounded-full h-1.5 overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-yellow-500 to-yellow-400" style="width: ${review.completion_percentage}%"></div>
                        </div>
                        <div class="text-gray-500 mt-1">${review.achievements_earned} / ${review.achievements_total} achievements</div>
                    </div>
                </div>
            `;
        }
        
        const card = document.createElement('div');
        card.className = 'review-card flex p-4 rounded-lg gap-4';
        card.innerHTML = `
            <div class="flex flex-col items-center gap-2 min-w-[70px]">
                <img src="${review.ra_profile_pic || '/static/img/default-avatar.png'}" 
                     alt="${review.ra_username}" 
                     class="w-12 h-12 rounded-lg border-2 border-gray-700">
                <div class="text-xs text-gray-300 font-bold text-center truncate w-full">${review.ra_username}</div>
                ${review.ra_total_points > 0 ? `
                    <div class="text-[10px] text-gray-500 flex items-center gap-1">
                        <span class="material-symbols-outlined text-xs text-yellow-500">emoji_events</span>
                        ${review.ra_total_points.toLocaleString()}
                    </div>
                ` : ''}
            </div>
            
            <div class="flex-1 min-w-0">
                <div class="bg-[#121921] p-3 mb-3 rounded flex items-center gap-3">
                    <span class="material-symbols-outlined text-3xl ${thumbColor}">${thumbIcon}</span>
                    <div>
                        <div class="text-white font-bold">${recText}</div>
                        <div class="text-xs text-gray-500">
                            Posted ${new Date(review.created_at).toLocaleDateString()}
                        </div>
                    </div>
                </div>
                
                ${progressHtml}
                
                ${review.review_text ? `
                    <p class="text-gray-300 text-sm leading-relaxed ${progressHtml ? 'mt-3' : ''} mb-4 whitespace-pre-wrap">${escapeHtml(review.review_text)}</p>
                ` : ''}
                
                <div class="border-t border-gray-700 pt-3 mt-3 flex flex-wrap items-center gap-3">
                    <span class="text-xs text-gray-500">Helpful?</span>
                    <button onclick="voteReview(${review.id}, 'yes')" 
                            class="vote-btn flex items-center gap-1 px-3 py-1.5 rounded text-xs transition ${userVote === 'yes' ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'}">
                        <span class="material-symbols-outlined text-sm">thumb_up</span> 
                        <span>${review.helpful_yes}</span>
                    </button>
                    <button onclick="voteReview(${review.id}, 'no')" 
                            class="vote-btn flex items-center gap-1 px-3 py-1.5 rounded text-xs transition ${userVote === 'no' ? 'bg-red-600 text-white' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'}">
                        <span class="material-symbols-outlined text-sm">thumb_down</span>
                        <span>${review.helpful_no}</span>
                    </button>
                </div>
            </div>
        `;
        container.appendChild(card);
    });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Vote on review
async function voteReview(reviewId, voteType) {
    if (!currentUser) {
        openRALogin();
        return;
    }
    
    try {
        const res = await fetch(`/api/reviews/vote/${reviewId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ vote_type: voteType })
        });
        
        const data = await res.json();
        
        if (data.success) {
            // Reload reviews to update counts without showing loader
            loadReviews(false, false);
        } else if (data.error === 'Login required') {
            openRALogin();
        }
    } catch (err) {
        console.error('Vote failed:', err);
    }
}

// Filter and sort
function filterReviews(filter) {
    currentFilter = filter;
    
    // Update button styles
    document.querySelectorAll('.review-filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === filter) {
            btn.classList.add('active');
        }
    });
    
    loadReviews(false, false); // Don't show loader for instant filter
}

function sortReviews(sort) {
    currentSort = sort;
    loadReviews(false, false); // Don't show loader for instant sort
}

function loadMoreReviews() {
    reviewsOffset += REVIEWS_LIMIT;
    loadReviews(true);
}
</script>
{% endblock %}