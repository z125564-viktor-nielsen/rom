{% extends 'base.html' %}

{% block title %}Web ROM Patcher | ROMHACKS.NET{% endblock %}

{% block meta_description %}Patch ROM hacks locally in your browser. Load your clean ROM + patch file (IPS/BPS/UPS/XDELTA) and export the patched ROM—no uploads.{% endblock %}
{% block meta_keywords %}rom patcher, web patcher, ips patcher, bps patcher, ups patcher, xdelta patcher, patch rom online{% endblock %}

{% block json_ld %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "ROMHACKS.NET Web Patcher",
    "description": "A free browser-based tool to apply ROM patches (IPS, BPS, UPS, XDELTA) to your game files locally without uploading.",
    "applicationCategory": "UtilitiesApplication",
    "operatingSystem": "Any (Browser-based)",
    "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
    },
    "featureList": ["IPS patching", "BPS patching", "UPS patching", "XDELTA patching", "Local ROM caching", "No file uploads"]
}
</script>
{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-10 md:space-y-16">
    
    <section>
        <h3 class="text-base md:text-lg font-bold text-white mb-4 md:mb-6 pixel-font flex items-center gap-2">
            <span class="material-symbols-outlined text-blue-500">checklist</span> Instructions
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
            <div class="step-card p-4 md:p-6 rounded-lg bg-[#151518]">
                <div class="flex items-center justify-between mb-3 md:mb-4">
                    <span class="material-symbols-outlined text-2xl md:text-3xl text-green-500">upload_file</span>
                    <span class="pixel-font text-xl md:text-2xl text-gray-700 font-bold opacity-30">01</span>
                </div>
                <h4 class="font-bold text-white mb-2 uppercase tracking-wide text-sm">Load ROM</h4>
                <p class="text-xs text-gray-400 leading-relaxed">Select your clean, legally dumped ROM file (e.g. .gba, .sfc, .z64). Your ROM is automatically cached locally for future use—no need to upload again!</p>
            </div>
            <div class="step-card p-4 md:p-6 rounded-lg bg-[#151518]">
                <div class="flex items-center justify-between mb-3 md:mb-4">
                    <span class="material-symbols-outlined text-2xl md:text-3xl text-green-500">folder_zip</span>
                    <span class="pixel-font text-xl md:text-2xl text-gray-700 font-bold opacity-30">02</span>
                </div>
                <h4 class="font-bold text-white mb-2 uppercase tracking-wide text-sm">Load Patch</h4>
                <p class="text-xs text-gray-400 leading-relaxed">Select the patch file. We support IPS, BPS, UPS, APS, MOD, PPF, and XDELTA formats.</p>
            </div>
            <div class="step-card p-4 md:p-6 rounded-lg bg-[#151518]">
                <div class="flex items-center justify-between mb-3 md:mb-4">
                    <span class="material-symbols-outlined text-2xl md:text-3xl text-green-500">download</span>
                    <span class="pixel-font text-xl md:text-2xl text-gray-700 font-bold opacity-30">03</span>
                </div>
                <h4 class="font-bold text-white mb-2 uppercase tracking-wide text-sm">Apply & Save</h4>
                <p class="text-xs text-gray-400 leading-relaxed">Click 'Apply Patch'. The browser processes the file instantly. Save the patched ROM to your device.</p>
            </div>
        </div>
    </section>

    <div class="border border-blue-500/30 bg-[#151518] p-1 relative overflow-hidden group shadow-[0_0_15px_rgba(59,130,246,0.1)]">
        <div class="absolute top-0 right-0 p-2 hidden md:block">
            <div class="w-16 h-16 border-t-2 border-r-2 border-blue-500/50 rounded-tr-xl"></div>
        </div>

        <div class="p-4 md:p-6 lg:p-10 relative z-10">
            <div class="flex flex-col md:flex-row md:items-center gap-3 md:gap-4 mb-6 md:mb-8 border-b border-gray-800 pb-4 md:pb-6">
                <span class="material-symbols-outlined text-3xl md:text-4xl text-blue-400 bg-blue-900/20 p-2 md:p-3 rounded w-fit">construction</span>
                <div>
                    <h2 class="text-xl md:text-2xl lg:text-3xl font-bold pixel-font text-white mb-1 md:mb-2">ROM Patcher</h2>
                    <p class="text-gray-400 text-xs md:text-sm font-mono leading-relaxed">
                        Supports: <strong class="text-blue-400">(IPS/BPS/UPS/APS/MOD/PPF/XDELTA)</strong>
                        <br class="hidden md:block">
                        <span class="hidden md:inline">Consoles:</span> <span class="text-gray-500">GBA, SNES, NES, N64, NDS, 3DS, GB, GBC, GEN, WII & more.</span>
                    </p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">
                <div class="space-y-6">
                    <div class="flex justify-end">
                        <label class="flex items-center gap-2 text-xs text-gray-500 hover:text-blue-400 cursor-pointer select-none">
                            <input id="ignore-checksum" type="checkbox" class="accent-blue-500 w-4 h-4 rounded border-gray-700 bg-gray-900">
                            Ignore Checksum Errors
                        </label>
                    </div>

                    <!-- SECTION 1: Cache a ROM to Browser -->
                    <div class="bg-purple-900/20 border border-purple-600/30 rounded-lg p-4 space-y-3">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="material-symbols-outlined text-purple-400">save</span>
                            <h4 class="text-sm font-bold text-purple-300 uppercase tracking-wide">Cache ROM to Browser</h4>
                        </div>
                        <p class="text-xs text-gray-400 leading-relaxed">Upload a ROM once to save it locally. It will be available for quick selection later—no need to re-upload!</p>
                        <div id="cache-rom-drop-zone" class="drop-zone rounded-lg p-4 text-center bg-[#0f0f12] cursor-pointer border-2 border-dashed border-purple-600/40 hover:border-purple-500 transition" style="user-select: none;">
                            <input id="cache-rom-file" type="file" class="hidden" accept=".gba,.sfc,.z64,.nes,.bin,.md,.smc,.iso,.nds,.3ds,.cia" />
                            <span class="material-symbols-outlined text-2xl text-purple-400 mb-1 pointer-events-none">cloud_upload</span>
                            <p class="text-xs text-purple-300 font-mono pointer-events-none">Click or drag ROM to cache it</p>
                        </div>
                        <p id="cache-status" class="text-xs text-gray-500 text-center hidden"></p>
                    </div>

                    <!-- Cached ROMs Library -->
                    <div id="cached-roms-section" class="hidden space-y-3">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-blue-400 text-lg">folder_special</span>
                                <h4 class="text-sm font-bold text-blue-300 uppercase tracking-wide">Your ROM Library</h4>
                            </div>
                            <span id="cache-size" class="text-xs text-gray-500 font-mono">0 MB</span>
                        </div>
                        <div id="cached-roms-list" class="space-y-2 max-h-48 overflow-y-auto">
                        </div>
                        <button id="clear-cache-btn" class="w-full text-xs bg-red-900/30 hover:bg-red-900/50 text-red-400 border border-red-600/30 py-2 rounded transition">
                            Clear All Cached ROMs
                        </button>
                    </div>

                    <!-- Divider -->
                    <div class="flex items-center gap-3 py-2">
                        <div class="flex-1 border-t border-gray-700"></div>
                        <span class="text-xs text-gray-500 uppercase tracking-wider">Select ROM for Patching</span>
                        <div class="flex-1 border-t border-gray-700"></div>
                    </div>

                    <!-- SECTION 2: Select ROM for Patching -->
                    <div class="bg-green-900/20 border border-green-600/30 rounded-lg p-4 space-y-3">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="material-symbols-outlined text-green-400">videogame_asset</span>
                            <h4 class="text-sm font-bold text-green-300 uppercase tracking-wide">Base ROM for Patching</h4>
                        </div>
                        
                        <!-- Select from cached ROMs dropdown -->
                        <div id="select-cached-rom-wrapper" class="hidden">
                            <label class="text-xs text-gray-400 mb-1 block">Pick from your cached ROMs:</label>
                            <select id="select-cached-rom" class="w-full bg-[#0f0f12] border border-green-600/40 rounded p-3 text-sm text-gray-300 cursor-pointer hover:border-green-500 transition">
                                <option value="">-- Select a cached ROM --</option>
                            </select>
                        </div>
                        
                        <!-- Or upload new -->
                        <div class="flex items-center gap-3 py-1" id="or-upload-divider">
                            <div class="flex-1 border-t border-gray-700/50"></div>
                            <span class="text-xs text-gray-600">or upload new</span>
                            <div class="flex-1 border-t border-gray-700/50"></div>
                        </div>
                        
                        <div id="rom-drop-zone" class="drop-zone rounded-lg p-4 text-center bg-[#0f0f12] cursor-pointer border-2 border-dashed border-green-600/40 hover:border-green-500 transition" style="user-select: none;">
                            <input id="rom-file" type="file" class="hidden" accept=".gba,.sfc,.z64,.nes,.bin,.md,.smc,.iso,.nds,.3ds,.cia" />
                            <span class="material-symbols-outlined text-2xl text-gray-500 mb-1 pointer-events-none">upload_file</span>
                            <p id="rom-label" class="text-xs text-gray-500 font-mono pointer-events-none">Click or drag ROM to use</p>
                        </div>
                        
                        <!-- Selected ROM indicator -->
                        <div id="selected-rom-indicator" class="hidden bg-green-900/40 border border-green-500/50 rounded p-3 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-outlined text-green-400">check_circle</span>
                                <span id="selected-rom-name" class="text-xs text-green-300 font-mono truncate"></span>
                            </div>
                            <button id="clear-selected-rom" class="text-xs text-red-400 hover:text-red-300 transition">Clear</button>
                        </div>
                    </div>

                    <!-- Privacy Disclaimer -->
                    <div class="bg-gray-900/50 border border-gray-700 rounded-lg p-3 flex gap-2">
                        <span class="material-symbols-outlined text-gray-500 flex-shrink-0 text-sm">lock</span>
                        <p class="text-xs text-gray-400 leading-relaxed">
                            <strong class="text-gray-300">Privacy Notice:</strong> Cached ROMs are saved to your browser's local storage. Nothing is ever uploaded to any server.
                        </p>
                    </div>

                    <div id="patch-drop-zone" class="drop-zone rounded-lg p-5 md:p-8 text-center bg-[#0f0f12]">
                        <input id="patch-file" type="file" class="hidden" accept=".ips,.bps,.ups,.xdelta,.ppf,.mod" />
                        <span class="material-symbols-outlined text-3xl md:text-4xl text-gray-500 mb-2">medical_services</span>
                        <h3 class="text-base md:text-lg font-bold text-gray-300 mb-1">Patch File</h3>
                        <p id="patch-label" class="text-xs text-gray-500 font-mono">Tap or drag & drop patch file</p>
                    </div>

                    <button id="apply-patch-btn" class="w-full bg-gray-700 text-gray-400 font-bold py-3 md:py-4 rounded cursor-not-allowed uppercase pixel-font text-[10px] md:text-xs tracking-wider transition-all border border-transparent disabled:opacity-50" disabled>
                        Apply Patch
                    </button>

                    <div id="export-rom-btn" class="hidden w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 md:py-4 rounded uppercase pixel-font text-[10px] md:text-xs tracking-wider flex items-center justify-center gap-2 shadow-[0_0_15px_rgba(59,130,246,0.4)] transition-all cursor-pointer transform active:scale-95">
                        <span class="material-symbols-outlined">save_alt</span> Save Patched ROM
                    </div>
                </div>

                <div class="flex flex-col h-full min-h-[300px] md:min-h-[400px]">
                    <div class="bg-black border border-gray-700 rounded-t p-2 md:p-3 flex justify-between items-center">
                        <span class="text-[10px] md:text-xs text-gray-500 uppercase font-bold tracking-wider">System Log</span>
                        <div class="flex gap-1.5 md:gap-2">
                            <div class="w-1.5 h-1.5 md:w-2 md:h-2 rounded-full bg-red-500"></div>
                            <div class="w-1.5 h-1.5 md:w-2 md:h-2 rounded-full bg-yellow-500"></div>
                            <div class="w-1.5 h-1.5 md:w-2 md:h-2 rounded-full bg-green-500"></div>
                        </div>
                    </div>
                    <div class="bg-black border-x border-b border-gray-700 rounded-b p-3 md:p-4 font-mono text-[10px] md:text-sm flex-grow overflow-y-auto shadow-inner relative" id="console-output">
                        <div class="text-green-500 mb-1">> SYSTEM_READY</div>
                        <div class="text-gray-500 mb-1">> Core: PATCHER_MODULE_LOADED</div>
                        <div class="text-gray-500 mb-1">> Waiting for input...</div>
                    </div>
                    <div class="mt-4 bg-[#1a1a20] rounded-full h-3 overflow-hidden border border-gray-700">
                        <div id="progress-bar" class="h-full bg-green-500 transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <section class="max-w-4xl mx-auto">
        <h3 class="text-lg font-bold text-white mb-6 pixel-font flex items-center gap-2 text-center justify-center">
            <span class="material-symbols-outlined text-blue-500">quiz</span> Frequently Asked Questions
        </h3>
        
        <div class="space-y-4">
            <details class="bg-[#151518] border border-gray-800 rounded group open:border-blue-500/50 transition-all">
                <summary class="flex justify-between items-center p-4 cursor-pointer">
                    <h4 class="font-bold text-gray-300 text-sm uppercase group-hover:text-white">I don't understand, what's a patcher?</h4>
                    <span class="material-symbols-outlined text-gray-500 group-open:rotate-180 transition-transform">expand_more</span>
                </summary>
                <div class="px-4 pb-4 text-xs text-gray-400 leading-relaxed border-t border-gray-800/50 pt-4">
                    A patcher is a tool that takes a normal ROM (the original game file) and applies a patch (the ROM hack) to it. The base ROM is the original, unmodified game the hack is built from (for example: Pokémon FireRed), and the patch contains all the changes that turn that ROM into the hacked version.
                </div>
            </details>

            <details class="bg-[#151518] border border-gray-800 rounded group open:border-blue-500/50 transition-all">
                <summary class="flex justify-between items-center p-4 cursor-pointer">
                    <h4 class="font-bold text-gray-300 text-sm uppercase group-hover:text-white">Is it safe to use this online patcher?</h4>
                    <span class="material-symbols-outlined text-gray-500 group-open:rotate-180 transition-transform">expand_more</span>
                </summary>
                <div class="px-4 pb-4 text-xs text-gray-400 leading-relaxed border-t border-gray-800/50 pt-4">
                    Yes. This tool runs entirely in your browser using JavaScript (Client-Side). Your ROM files are never uploaded to any server. The patching process happens locally on your device's memory.
                </div>
            </details>

            <details class="bg-[#151518] border border-gray-800 rounded group open:border-blue-500/50 transition-all">
                <summary class="flex justify-between items-center p-4 cursor-pointer">
                    <h4 class="font-bold text-gray-300 text-sm uppercase group-hover:text-white">What formats are supported?</h4>
                    <span class="material-symbols-outlined text-gray-500 group-open:rotate-180 transition-transform">expand_more</span>
                </summary>
                <div class="px-4 pb-4 text-xs text-gray-400 leading-relaxed border-t border-gray-800/50 pt-4">
                    We support the most common patching formats: <strong>IPS, BPS, UPS, APS, MOD, PPF, and XDELTA/VCDIFF</strong>. We support ROMs for GBA, SNES, NES, N64, NDS, 3DS, Genesis, Wii, GameCube, and more.
                </div>
            </details>

            <details class="bg-[#151518] border border-gray-800 rounded group open:border-blue-500/50 transition-all">
                <summary class="flex justify-between items-center p-4 cursor-pointer">
                    <h4 class="font-bold text-gray-300 text-sm uppercase group-hover:text-white">The patch didn't work / Game glitches?</h4>
                    <span class="material-symbols-outlined text-gray-500 group-open:rotate-180 transition-transform">expand_more</span>
                </summary>
                <div class="px-4 pb-4 text-xs text-gray-400 leading-relaxed border-t border-gray-800/50 pt-4">
                    This usually happens if your base ROM version doesn't match the one the patch was made for.
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li>Check if you need a "Headered" or "Unheadered" ROM (common for SNES).</li>
                        <li>Ensure the region matches (USA vs Europe vs Japan).</li>
                        <li>Check the file revision (Rev A, v1.0, v1.1).</li>
                    </ul>
                </div>
            </details>
            
            <details class="bg-[#151518] border border-gray-800 rounded group open:border-blue-500/50 transition-all">
                <summary class="flex justify-between items-center p-4 cursor-pointer">
                    <h4 class="font-bold text-gray-300 text-sm uppercase group-hover:text-white">How do I fix "Checksum Mismatch"?</h4>
                    <span class="material-symbols-outlined text-gray-500 group-open:rotate-180 transition-transform">expand_more</span>
                </summary>
                <div class="px-4 pb-4 text-xs text-gray-400 leading-relaxed border-t border-gray-800/50 pt-4">
                    Formats like BPS and UPS verify the original file before patching. If you get an error, your ROM is likely different from the required one. You can try checking the "Ignore Checksum Errors" box, but the game might crash or contain bugs.
                </div>
            </details>
        </div>
    </section>
</div>

<script>
    let currentROM = null;
    let currentPatch = null;
    let currentROMName = null;

    // Initialize cache UI on page load
    document.addEventListener('DOMContentLoaded', async function() {
        await updateCachedROMsList();
        await updateCachedROMsDropdown();
    });

    // Update cached ROMs list UI (the library view)
    async function updateCachedROMsList() {
        const roms = await romCache.getAllROMs();
        const section = document.getElementById('cached-roms-section');
        const list = document.getElementById('cached-roms-list');
        const cacheSize = document.getElementById('cache-size');
        const selectWrapper = document.getElementById('select-cached-rom-wrapper');
        const orDivider = document.getElementById('or-upload-divider');
        
        if (roms.length === 0) {
            section.classList.add('hidden');
            selectWrapper.classList.add('hidden');
            orDivider.classList.add('hidden');
            return;
        }
        
        section.classList.remove('hidden');
        selectWrapper.classList.remove('hidden');
        orDivider.classList.remove('hidden');
        list.innerHTML = '';
        
        const totalSize = await romCache.getTotalSize();
        cacheSize.textContent = formatBytes(totalSize);
        
        roms.sort((a, b) => b.timestamp - a.timestamp).forEach(rom => {
            const item = document.createElement('div');
            item.className = 'bg-blue-900/20 border border-blue-600/30 rounded p-3 flex justify-between items-center';
            item.innerHTML = `
                <div class="flex-1 min-w-0">
                    <p class="text-xs font-mono text-blue-300 truncate">${rom.filename}</p>
                    <p class="text-xs text-gray-500">${formatBytes(rom.size)} • CRC32: ${rom.crc32.toString(16).toUpperCase().padStart(8, '0')}</p>
                </div>
                <div class="flex gap-2 ml-3">
                    <button class="text-xs bg-red-900/50 hover:bg-red-900 text-red-400 px-3 py-1 rounded transition"
                            onclick="deleteCachedROM('${rom.id}')">Delete</button>
                </div>
            `;
            list.appendChild(item);
        });
    }

    // Update the dropdown for selecting cached ROMs for patching
    async function updateCachedROMsDropdown() {
        const roms = await romCache.getAllROMs();
        const select = document.getElementById('select-cached-rom');
        
        // Clear existing options except the first one
        select.innerHTML = '<option value="">-- Select a cached ROM --</option>';
        
        roms.sort((a, b) => b.timestamp - a.timestamp).forEach(rom => {
            const option = document.createElement('option');
            option.value = rom.id;
            option.textContent = `${rom.filename} (${formatBytes(rom.size)})`;
            select.appendChild(option);
        });
    }

    // Handle selecting a ROM from dropdown for patching
    document.getElementById('select-cached-rom').addEventListener('change', async function(e) {
        const id = e.target.value;
        if (!id) return;
        
        const rom = await romCache.getROM(id);
        if (rom) {
            currentROM = new Uint8Array(rom.data);
            currentROMName = rom.filename;
            showSelectedROMIndicator(rom.filename, rom.size);
            updateApplyButtonState();
            logToConsole(`✓ Selected cached ROM: ${rom.filename}`);
        }
    });

    // Show the selected ROM indicator
    function showSelectedROMIndicator(filename, size) {
        const indicator = document.getElementById('selected-rom-indicator');
        const nameSpan = document.getElementById('selected-rom-name');
        nameSpan.textContent = `${filename} (${formatBytes(size)})`;
        indicator.classList.remove('hidden');
        
        // Update the drop zone to show it's been used
        document.getElementById('rom-drop-zone').classList.add('opacity-50');
        document.getElementById('rom-label').textContent = 'ROM selected above';
    }

    // Clear selected ROM
    document.getElementById('clear-selected-rom').addEventListener('click', function() {
        currentROM = null;
        currentROMName = null;
        document.getElementById('selected-rom-indicator').classList.add('hidden');
        document.getElementById('select-cached-rom').value = '';
        document.getElementById('rom-drop-zone').classList.remove('opacity-50', 'bg-green-900/20', 'border-green-600/30');
        document.getElementById('rom-label').textContent = 'Click or drag ROM to use';
        document.getElementById('rom-label').className = 'text-xs text-gray-500 font-mono pointer-events-none';
        updateApplyButtonState();
        logToConsole('ROM selection cleared');
    });

    async function deleteCachedROM(id) {
        if (confirm('Delete this cached ROM?')) {
            await romCache.deleteROM(id);
            await updateCachedROMsList();
            await updateCachedROMsDropdown();
            logToConsole('Cached ROM deleted');
        }
    }

    document.getElementById('clear-cache-btn').addEventListener('click', async function() {
        if (confirm('Clear all cached ROMs? This cannot be undone.')) {
            await romCache.clearAll();
            await updateCachedROMsList();
            await updateCachedROMsDropdown();
            logToConsole('Cache cleared');
        }
    });

    // ===== CACHE ROM SECTION (Purple box - just for caching) =====
    const cacheRomFileInput = document.getElementById('cache-rom-file');
    const cacheRomDropZone = document.getElementById('cache-rom-drop-zone');
    const cacheStatus = document.getElementById('cache-status');

    cacheRomDropZone.addEventListener('click', () => cacheRomFileInput.click());
    
    cacheRomDropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        cacheRomDropZone.style.borderColor = '#a855f7';
    });
    
    cacheRomDropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        cacheRomDropZone.style.borderColor = '';
    });
    
    cacheRomDropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        cacheRomDropZone.style.borderColor = '';
        if (e.dataTransfer.files.length) {
            handleCacheROMFile(e.dataTransfer.files[0]);
        }
    });

    cacheRomFileInput.addEventListener('change', (e) => {
        if (e.target.files.length) {
            handleCacheROMFile(e.target.files[0]);
            cacheRomFileInput.value = '';
        }
    });

    async function handleCacheROMFile(file) {
        cacheStatus.classList.remove('hidden');
        cacheStatus.textContent = 'Caching ROM...';
        cacheStatus.className = 'text-xs text-yellow-400 text-center';
        
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                await romCache.addROM(file, e.target.result);
                await updateCachedROMsList();
                await updateCachedROMsDropdown();
                
                cacheStatus.textContent = `✓ ${file.name} cached successfully!`;
                cacheStatus.className = 'text-xs text-green-400 text-center';
                logToConsole(`✓ ROM cached: ${file.name}`);
                
                // Hide status after 3 seconds
                setTimeout(() => {
                    cacheStatus.classList.add('hidden');
                }, 3000);
            } catch (err) {
                cacheStatus.textContent = `Error: ${err.message}`;
                cacheStatus.className = 'text-xs text-red-400 text-center';
                logToConsole(`Error caching ROM: ${err.message}`);
            }
        };
        reader.readAsArrayBuffer(file);
    }

    // ===== ROM FOR PATCHING SECTION (Green box - upload new ROM) =====
    const romFileInput = document.getElementById('rom-file');
    const romDropZone = document.getElementById('rom-drop-zone');
    
    romDropZone.addEventListener('click', (e) => {
        romFileInput.click();
    }, { once: false });
    
    romDropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        romDropZone.style.borderColor = '#22c55e';
    });
    
    romDropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        romDropZone.style.borderColor = '';
    });
    
    romDropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        romDropZone.style.borderColor = '';
        if (e.dataTransfer.files.length) {
            handleROMFile(e.dataTransfer.files[0]);
        }
    });

    let isProcessingROM = false;
    romFileInput.addEventListener('change', (e) => {
        if (isProcessingROM) return;
        if (e.target.files.length) {
            isProcessingROM = true;
            handleROMFile(e.target.files[0]);
            romFileInput.value = '';
            setTimeout(() => { isProcessingROM = false; }, 100);
        }
    });

    async function handleROMFile(file) {
        const reader = new FileReader();
        reader.onload = async (e) => {
            currentROM = new Uint8Array(e.target.result);
            currentROMName = file.name;
            
            // Also auto-cache it for convenience
            try {
                await romCache.addROM(file, e.target.result);
                await updateCachedROMsList();
                await updateCachedROMsDropdown();
                logToConsole(`✓ ROM loaded and cached: ${file.name}`);
            } catch (err) {
                logToConsole(`ROM loaded (cache failed: ${err.message})`);
            }
            
            // Show selected indicator
            showSelectedROMIndicator(file.name, file.size);
            document.getElementById('select-cached-rom').value = '';
            
            updateApplyButtonState();
        };
        reader.readAsArrayBuffer(file);
    }

    // Patch file handler (keeping existing logic)
    const patchFileInput = document.getElementById('patch-file');
    const patchDropZone = document.getElementById('patch-drop-zone');
    
    patchDropZone.addEventListener('click', () => patchFileInput.click());
    patchDropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        patchDropZone.style.borderColor = '#3b82f6';
    });
    patchDropZone.addEventListener('dragleave', () => {
        patchDropZone.style.borderColor = '';
    });
    patchDropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        patchDropZone.style.borderColor = '';
        if (e.dataTransfer.files.length) {
            const file = e.dataTransfer.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                currentPatch = new Uint8Array(event.target.result);
                document.getElementById('patch-label').textContent = `✓ ${file.name}`;
                document.getElementById('patch-label').className = 'text-xs text-green-400 font-mono';
                patchDropZone.classList.add('bg-green-900/20', 'border-green-600/30');
                patchDropZone.classList.remove('bg-[#0f0f12]');
                updateApplyButtonState();
            };
            reader.readAsArrayBuffer(file);
        }
    });

    patchFileInput.addEventListener('change', (e) => {
        if (e.target.files.length) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                currentPatch = new Uint8Array(event.target.result);
                document.getElementById('patch-label').textContent = `✓ ${file.name}`;
                document.getElementById('patch-label').className = 'text-xs text-green-400 font-mono';
                patchDropZone.classList.add('bg-green-900/20', 'border-green-600/30');
                patchDropZone.classList.remove('bg-[#0f0f12]');
                updateApplyButtonState();
            };
            reader.readAsArrayBuffer(file);
        }
    });

    function updateApplyButtonState() {
        const btn = document.getElementById('apply-patch-btn');
        if (currentROM && currentPatch) {
            btn.disabled = false;
            btn.classList.remove('bg-gray-700', 'text-gray-400', 'cursor-not-allowed');
            btn.classList.add('bg-blue-600', 'hover:bg-blue-500', 'text-white', 'cursor-pointer', 'shadow-[0_0_15px_rgba(59,130,246,0.4)]');
        } else {
            btn.disabled = true;
            btn.classList.add('bg-gray-700', 'text-gray-400', 'cursor-not-allowed');
            btn.classList.remove('bg-blue-600', 'hover:bg-blue-500', 'text-white', 'cursor-pointer', 'shadow-[0_0_15px_rgba(59,130,246,0.4)]');
        }
    }

    function logToConsole(message) {
        const consoleOutput = document.getElementById('console-output');
        const line = document.createElement('div');
        line.className = message.includes('✓') || message.includes('cached') ? 'text-green-500 mb-1' : 'text-gray-400 mb-1';
        line.textContent = '> ' + message;
        consoleOutput.appendChild(line);
        consoleOutput.scrollTop = consoleOutput.scrollHeight;
    }
</script>
{% endblock %}